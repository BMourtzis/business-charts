import{u as se,a as le,_ as ie,d as de,B as ce,e as ue,s as P,f as me}from"./useVariationTableMapper-rbYJPx-e.js";import{g as pe}from"./usePartnerDetails-CppZuLO_.js";import{d as I,g as $,r as T,c as C,I as z,e as a,l as d,q as i,m as w,x as b,u as s,$ as B,A as q,F as ve,o as _,C as S,a6 as _e,y,z as p,H as G,_ as K,a7 as F,a8 as L,a9 as W,aa as x,ab as fe,ac as he,ad as R,ae as ye,G as N,B as g,a4 as ge}from"./index-bd2o7H6g.js";import{n as J,g as Oe}from"./priceUtils-1yxS_Q4Z.js";import{_ as we}from"./ConfirmDeleteModal.vue_vue_type_script_setup_true_lang-SrsffVCl.js";import{M as j,a as be,b as xe,u as Me,_ as Ce,c as Se}from"./MovementReasonChip.vue_vue_type_script_setup_true_lang-Cqm-y2wy.js";function Q(t){return t.toLocaleDateString()}function V(t){return J(t)}function De(t){const e=ke(t);Ie(e,`${t.orderNumber}-printlist.csv`)}function ke(t){return t.items.length?[["MODEL","Size"].join(","),...t.items.flatMap(o=>Be(o))].join(`
\r`):""}function Be(t){const e=`${t.sku.productCode}${t.sku.getSnapshotValues(["size"]).join(" ")}`,n=t.sku.size,o=`${e}, ${n}`;return Array(t.quantity).fill(o)}function Ie(t,e="export.csv"){const n=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.setAttribute("download",e),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}const $e=I({__name:"OrderDetailsHeaderMenu",props:{order:{}},setup(t){const e=ve(),{tCap:n}=$(),{deleteOrderCommmandHandler:o}=se(),r=t,c=T(!1),l=T(!1);function v(){return`#${r.order.orderNumber}`}function u(){e.back(),o.handle({id:r.order.id})}return(h,f)=>{const m=d("v-btn"),O=d("v-list-item"),M=d("v-list"),D=d("v-menu");return _(),C(z,null,[a(D,{modelValue:c.value,"onUpdate:modelValue":f[2]||(f[2]=A=>c.value=A)},{activator:i(({props:A})=>[a(m,q({icon:"mdi-dots-vertical",variant:"text"},A),null,16)]),default:i(()=>[a(M,null,{default:i(()=>[a(O,{"prepend-icon":"mdi-file-delimited",title:s(n)("order.labelCsvTitle"),onClick:f[0]||(f[0]=A=>s(De)(t.order))},null,8,["title"]),a(O,{"prepend-icon":"mdi-invoice-export-outline",title:s(n)("order.exportInvoiceTitle")},null,8,["title"]),t.order.status===s(B).Draft?(_(),w(O,{key:0,"prepend-icon":"mdi-trash-can",title:s(n)("common.delete"),class:"text-red",onClick:f[1]||(f[1]=()=>{c.value=!1,l.value=!0})},null,8,["title"])):b("",!0)]),_:1})]),_:1},8,["modelValue"]),a(we,{modelValue:l.value,"onUpdate:modelValue":f[3]||(f[3]=A=>l.value=A),name:v(),"action-fn":()=>u(),hide:""},null,8,["modelValue","name","action-fn"])],64)}}}),U=T();function Ae(){function t(e){U.value?.open(e)}return{dialogRef:U,openApproveModal:t}}const Te={key:0,class:"d-flex button-with-options"},Ve=I({__name:"BtnWithOptions",props:{mainBtnOptions:{},menuOptions:{}},emits:["action"],setup(t,{emit:e}){const n=t,o=S(()=>({"left-btn":n.menuOptions.length>0}));return(r,c)=>{const l=d("v-btn"),v=d("v-icon"),u=d("v-list-item"),h=d("v-list"),f=d("v-menu");return t.mainBtnOptions?(_(),C("div",Te,[a(l,{class:_e(o.value),size:"small",variant:"flat",text:t.mainBtnOptions.title,color:t.mainBtnOptions.color,icon:t.mainBtnOptions.icon,onClick:c[0]||(c[0]=m=>r.$emit("action",t.mainBtnOptions))},{default:i(()=>[y(p(t.mainBtnOptions.title),1)]),_:1},8,["class","text","color","icon"]),t.menuOptions.length>0?(_(),w(f,{key:0,"offset-y":""},{activator:i(({props:m})=>[a(l,q(m,{class:"right-btn",variant:"flat",size:"small",color:t.mainBtnOptions.color}),{default:i(()=>[a(v,null,{default:i(()=>[...c[1]||(c[1]=[y("mdi-chevron-down",-1)])]),_:1})]),_:1},16,["color"])]),default:i(()=>[a(h,null,{default:i(()=>[(_(!0),C(z,null,G(t.menuOptions,m=>(_(),w(u,{"prepend-icon":m.icon,color:m.color,title:m.title,onClick:O=>r.$emit("action",m)},null,8,["prepend-icon","color","title","onClick"]))),256))]),_:1})]),_:1})):b("",!0)])):b("",!0)}}}),Ee=K(Ve,[["__scopeId","data-v-a1906379"]]);class Le{static resolve(e){if(e===j.In)return F.Apply;if(e===j.Out)return F.Reverse;throw new Error("Unsupported money direction")}}class Re{constructor(e=L(),n=W()){this._orderStore=e,this._moneyMovementStore=n}async handle(e){const n=await this.getOrder(e.orderId);if(n.approve(),e.deposit){const o=await this.createMoneyMovement(n.partnerId,n.type,e.deposit.amount,e.deposit.method);this.allocateMoneyToOrder(n,o.direction,o.id,e.deposit.amount),this.saveMoneyMovement(o)}this.updateOrder(n)}async getOrder(e){const n=await x.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async createMoneyMovement(e,n,o,r){const c=await be.getNext(e);return xe.createPaymentFromOrder(n,e,c,o,r)}allocateMoneyToOrder(e,n,o,r){const c=Le.resolve(n);e.allocateMoney(o,r,c)}async saveMoneyMovement(e){await fe.add(e),this._moneyMovementStore.add(he.toDTO(e))}async updateOrder(e){await x.update(e),this._orderStore.update(R.toDTO(e))}}class ze{constructor(e=L()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.toProcessing(),await this.updateOrder(n)}async getOrder(e){const n=await x.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await x.update(e),this._orderStore.update(R.toDTO(e))}}class Ne{constructor(e=L()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.readyForShipment(),await this.updateOrder(n)}async getOrder(e){const n=await x.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await x.update(e),this._orderStore.update(R.toDTO(e))}}class He{constructor(e=L()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.shipOrder(),await this.updateOrder(n)}async getOrder(e){const n=await x.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await x.update(e),this._orderStore.update(R.toDTO(e))}}function Pe(t){const e=S(()=>Fe(t.value.status)),{tCap:n}=$();function o(){const u=[r(),c(),l(),v()].filter(m=>m!==null),[h,...f]=u;return{mainBtnOptions:h,menuOptions:f}}function r(){return E(e.value,B.Approved)?{id:"approve",title:n("order.approveBtn"),color:"indigo",execute:async u=>{const h={orderId:t.value.id};u?.amount&&u.amount>0&&u?.method&&(h.deposit={amount:u.amount,method:u.method}),await new Re().handle(h)}}:null}function c(){return E(e.value,B.Processing)?{id:"processing",title:n("order.processingBtn"),color:"indigo",execute:async()=>{try{await new ze().handle({orderId:t.value.id})}catch(u){u instanceof Error&&alert(u.message)}}}:null}function l(){return E(e.value,B.ReadyForShipment)?{id:"readyForShipment",title:n("order.readyForShipmentBtn"),color:"indigo",execute:async()=>{try{await new Ne().handle({orderId:t.value.id})}catch(u){u instanceof Error&&alert(u.message)}}}:null}function v(){return E(e.value,B.Shipped)?{id:"shipped",title:n("order.shippedBtn"),color:"indigo",execute:async()=>{try{await new He().handle({orderId:t.value.id})}catch(u){u instanceof Error&&alert(u.message)}}}:null}return{mainBtnOptions:S(()=>o()),canCancel:S(()=>E(e.value,B.Cancelled)),canComplete:S(()=>E(e.value,B.Completed))}}function Fe(t){return ye[t]}function E(t,e){return t.includes(e)}const je=I({__name:"ApproveOrderModal",setup(t,{expose:e}){const{tCap:n}=$(),{paymentMethodTypes:o}=Me(),r=T(!1),c=T(!1),l=T(0),v=T(null),u=T(null);let h=null;function f(M){const D=M.initialInput?.amount??0;l.value=Number(D.toFixed(2)),h=M.onConfirm,r.value=!0}function m(){r.value=!1}async function O(){if(h){c.value=!0;try{await h({amount:l.value,method:v.value}),m()}catch(M){M instanceof Error&&(u.value=M.message)}finally{c.value=!1}}}return e({open:f}),(M,D)=>{const A=d("v-card-title"),X=d("v-text-field"),Y=d("v-icon"),Z=d("v-select"),ee=d("v-alert"),te=d("v-card-text"),ne=d("v-spacer"),H=d("v-btn"),oe=d("v-card-actions"),re=d("v-card"),ae=d("v-dialog");return _(),w(ae,{modelValue:r.value,"onUpdate:modelValue":D[2]||(D[2]=k=>r.value=k),"max-width":"420"},{default:i(()=>[a(re,null,{default:i(()=>[a(A,null,{default:i(()=>[y(p(s(n)("order.approveOrderTitle")),1)]),_:1}),a(te,null,{default:i(()=>[a(X,{modelValue:l.value,"onUpdate:modelValue":D[0]||(D[0]=k=>l.value=k),modelModifiers:{number:!0},label:s(n)("order.deposit"),type:"number",min:0,step:"0.01",inputmode:"decimal",suffix:s(Oe)(),autofocus:""},null,8,["modelValue","label","suffix"]),a(Z,{modelValue:v.value,"onUpdate:modelValue":D[1]||(D[1]=k=>v.value=k),label:s(n)("moneyMovement.method"),items:s(o),"item-title":"title","item-value":"value","item-props":k=>({prependIcon:k.icon})},{selection:i(({item:k})=>[a(Y,{class:"mr-2"},{default:i(()=>[y(p(k.raw.icon),1)]),_:2},1024),y(" "+p(k.raw.title),1)]),_:1},8,["modelValue","label","items","item-props"]),u.value?(_(),w(ee,{key:0,type:"error",variant:"tonal",density:"compact",class:"mt-2"},{default:i(()=>[y(p(u.value),1)]),_:1})):b("",!0)]),_:1}),a(oe,null,{default:i(()=>[a(ne),a(H,{variant:"text",onClick:m},{default:i(()=>[y(p(s(n)("common.cancel")),1)]),_:1}),a(H,{color:"indigo",loading:c.value,onClick:O},{default:i(()=>[y(p(s(n)("order.approveBtn")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}});class Ue{constructor(e=L()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.completeOrder(),await this.updateOrder(n)}async getOrder(e){const n=await x.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await x.update(e),this._orderStore.update(R.toDTO(e))}}class qe{constructor(e=L()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.cancelOrder(),await this.updateOrder(n)}async getOrder(e){const n=await x.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await x.update(e),this._orderStore.update(R.toDTO(e))}}const Ge=I({__name:"OrderDetailsHeaderStatus",props:{order:{}},setup(t){const e=t,{tCap:n}=$(),{mainBtnOptions:o,canCancel:r,canComplete:c}=Pe(N(e,"order")),{dialogRef:l,openApproveModal:v}=Ae();function u(m){if(m.id==="approve"){v({initialInput:{amount:e.order.depositAmount},onConfirm:async O=>{m.execute(O)}});return}m.execute()}async function h(){try{await new Ue().handle({orderId:e.order.id})}catch(m){m instanceof Error&&alert(m.message)}}async function f(){try{await new qe().handle({orderId:e.order.id})}catch(m){m instanceof Error&&alert(m.message)}}return(m,O)=>{const M=d("v-btn");return _(),C(z,null,[s(o).mainBtnOptions?(_(),w(Ee,{key:0,"main-btn-options":s(o).mainBtnOptions,"menu-options":s(o).menuOptions,onAction:u,class:"mr-2"},null,8,["main-btn-options","menu-options"])):b("",!0),s(c)?(_(),w(M,{key:1,color:"grey",variant:"flat",size:"small",text:s(n)("order.completedBtn"),class:"mr-2",onClick:h},null,8,["text"])):b("",!0),s(r)?(_(),w(M,{key:2,color:"red",variant:"flat",size:"small",text:s(n)("order.cancelledBtn"),onClick:f},null,8,["text"])):b("",!0),a(je,{ref_key:"dialogRef",ref:l},null,512)],64)}}}),Ke={class:"mr-2"},We={key:0,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},Je={key:1,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},Qe={class:"text-subtitle-1 text-grey-darken-1 font-weight-bold order-details-line"},Xe={class:"formatted-notes"},Ye={class:"text-h5 font-weight-bold"},Ze={key:0},et={key:0},tt=I({__name:"OrderDetailsHeader",props:{order:{}},setup(t){const{tCap:e}=$(),n=t,o=S(()=>pe(n.order.partnerId));function r(){return`#${n.order.orderNumber}`}return(c,l)=>{const v=d("v-col"),u=d("v-row"),h=d("v-btn");return _(),C(z,null,[a(u,{align:"start",justify:"space-between",dense:""},{default:i(()=>[a(v,{cols:"5",class:"d-flex",justify:"start"},{default:i(()=>[g("h1",Ke,p(r()),1),a(le,{status:t.order.status,class:"ml-2 mt-2"},null,8,["status"]),a(ie,{type:t.order.type,class:"ml-2 mt-2"},null,8,["type"])]),_:1}),a(v,{cols:"4",class:"d-flex flex-row justify-end"},{default:i(()=>[a(Ge,{order:t.order},null,8,["order"])]),_:1}),a(v,{cols:"1",class:"d-flex flex-row justify-end"},{default:i(()=>[a($e,{order:t.order},null,8,["order"])]),_:1})]),_:1}),a(u,{align:"start",justify:"space-between",dense:""},{default:i(()=>[a(v,{cols:"3",class:"text-md-left"},{default:i(()=>[o.value?(_(),C("div",We,[g("strong",null,p(s(e)("partner.customer")),1),l[0]||(l[0]=y(": ",-1)),a(h,{variant:"text",to:`/partner/${o.value.id}`},{default:i(()=>[y(p(o.value.businessName),1)]),_:1},8,["to"])])):b("",!0),t.order.dueDate?(_(),C("div",Je,[g("strong",null,p(s(e)("order.dueDate")),1),y(": "+p(s(Q)(t.order.dueDate)),1)])):b("",!0),g("div",Qe,p(s(e)("order.notes"))+": ",1),g("span",Xe,p(t.order.notes),1)]),_:1}),a(v,{cols:"4",md:"5",class:"text-md-right"},{default:i(()=>[g("span",null,p(s(e)("order.total")),1),g("div",Ye,p(s(V)(t.order.totalAmount)),1),g("div",null,[y(p(s(e)("order.orderSum"))+" ",1),g("strong",null,p(s(V)(t.order.subtotal)),1),y(" · "+p(s(e)("order.vatRate"))+" ",1),g("strong",null,p(s(V)(t.order.taxAmount)),1),t.order.discountAmount>0?(_(),C("span",Ze,[y(" · "+p(s(e)("order.discount"))+" ",1),g("strong",null,p(s(V)(t.order.discountAmount)),1)])):b("",!0)]),t.order.depositAmount>0?(_(),C("div",et,[y(p(s(e)("order.deposit"))+" ",1),g("strong",null,p(s(V)(t.order.depositAmount)),1),y(" · "+p(s(e)("order.remainingAmount"))+" ",1),g("strong",null,p(s(V)(t.order.remainingAmount)),1)])):b("",!0)]),_:1})]),_:1})],64)}}}),nt=K(tt,[["__scopeId","data-v-cf0cee66"]]),ot=I({__name:"DisplayTable",props:{tableRows:{},tableColumns:{},hideRowIndex:{type:Boolean}},setup(t){const e=t,n=S(()=>de(e.tableRows));return(o,r)=>(_(),w(ce,{modelValue:n.value,"table-columns":t.tableColumns,"hide-row-index":t.hideRowIndex},null,8,["modelValue","table-columns","hide-row-index"]))}});function rt(t){const e=t.map(at);return st(e)}function at(t){const e=t.sku.variationSnapshot.attributes??{},{size:n,...o}=e;return{name:t.name,unitPrice:t.unitPrice,productCode:t.productCode,derivedSku:ge(t.productCode,{attributes:o,flags:t.sku.variationSnapshot.flags}),variationSnapshot:{attributes:o,flags:t.sku.variationSnapshot.flags},sizing:lt(n,t.quantity)}}function st(t){const e=new Map;for(const n of t){const o=n.derivedSku,r=e.get(o);if(r)for(const[c,l]of Object.entries(n.sizing))r.sizing[c]=(r.sizing[c]||0)+l;else e.set(o,{...n,sizing:{...n.sizing}})}return[...e.values()]}function lt(t,e){return{[`shoe:${t}`]:e}}const it=I({__name:"OrderDetailsLineItems",props:{order:{}},setup(t){const{tCap:e}=$(),{vmToRows:n}=ue(P),o=t,r=S(()=>{const c=rt([...o.order.items]);return n(c)});return(c,l)=>{const v=d("v-list-item"),u=d("v-card-title"),h=d("v-card-text"),f=d("v-card");return _(),w(f,null,{default:i(()=>[a(u,null,{default:i(()=>[a(v,null,{title:i(()=>[g("h3",null,p(s(e)("order.items",2)),1)]),_:1})]),_:1}),a(h,null,{default:i(()=>[a(ot,{tableRows:r.value,"table-columns":s(P)},null,8,["tableRows","table-columns"])]),_:1})]),_:1})}}});function dt(t){const{tCap:e}=$(),n=[{name:"created",title:e("order.createdDate"),getDate:r=>r.createdDate},{name:"apporved",title:e("order.approvedDate"),getDate:r=>r.approvedDate},{name:"shipped",title:e("order.shippedDate"),getDate:r=>r.shippedDate},{name:"completed",title:e("order.completedDate"),getDate:r=>r.completedDate}],o={name:"cancelled",title:e("order.cancelledDate"),getDate:r=>r.cancelledDate,isCancelled:!0};return{timelineItems:S(()=>ct(t.value,n,o))}}function ct(t,e,n){const o=[...e];t.status===B.Cancelled&&o.push(n);let r=o.map(l=>({name:l.name,title:l.title,date:l.getDate(t)}));t.status===B.Cancelled&&(r=r.filter(l=>l.date));const c=r.map(l=>l.date).findLastIndex(l=>l!==void 0);return r.map((l,v)=>t.status===B.Cancelled&&l.name==="cancelled"?{...l,colour:"red"}:l.date?{...l,colour:v===c?"indigo":"cyan"}:{...l,colour:"grey"})}const ut={class:"d-flex"},mt={key:0,class:"me-4"},pt=I({__name:"OrderDetailsTimeline",props:{order:{}},setup(t){const{tCap:e}=$(),n=t,{timelineItems:o}=dt(N(n,"order"));return(r,c)=>{const l=d("v-card-title"),v=d("v-divider"),u=d("v-timeline-item"),h=d("v-timeline"),f=d("v-card-text"),m=d("v-card");return _(),w(m,null,{default:i(()=>[a(l,null,{default:i(()=>[y(p(s(e)("common.timeline")),1)]),_:1}),a(v),a(f,null,{default:i(()=>[a(h,{align:"start",side:"end"},{default:i(()=>[(_(!0),C(z,null,G(s(o),O=>(_(),w(u,{"dot-color":O.colour,size:"small"},{opposite:i(()=>[g("div",null,p(O.title),1)]),default:i(()=>[g("div",ut,[O.date?(_(),C("strong",mt,p(s(Q)(O.date)),1)):b("",!0)])]),_:2},1032,["dot-color"]))),256))]),_:1})]),_:1})]),_:1})}}});function vt(t,e){const n=e.find(o=>o.id===t.moneyMovementId);return n?{moneyMovementId:t.moneyMovementId,movementNumber:_t(n?.movementNumber),amount:J(t.amount),allocatedAt:ft(t.allocatedAt),direction:n.direction,method:n.method,reason:n.reason}:null}function _t(t){return`#${t}`}function ft(t){return t?t.toLocaleDateString():"-"}function ht(t){if(t.length===0)return[];const e=W();return[...new Set(t.map(o=>o.moneyMovementId))].map(o=>e.getMoneyMovementById(o)).filter(o=>o!=null)}function yt(t){return[{title:t("moneyMovement.number"),key:"movementNumber",align:"start"},{title:t("order.allocatedAt"),key:"allocatedAt",align:"start"},{title:t("moneyMovement.reason"),key:"reason",align:"start"},{title:t("moneyMovement.method"),key:"method",align:"start"},{title:t("moneyMovement.amount"),key:"amount",align:"start"}]}function gt(t){const{tCap:e}=$(),n=S(()=>{const r=t.value??[],c=ht(r);return r.map(l=>vt(l,c)).filter(l=>l!=null)}),o=S(()=>yt(e));return{data:n,headers:o}}const Ot=I({__name:"OrderDetailsMoneyAllocations",props:{allocations:{}},setup(t){const{tCap:e}=$(),n=t,{data:o,headers:r}=gt(N(n,"allocations"));return(c,l)=>{const v=d("v-card-title"),u=d("v-data-table"),h=d("v-card-text"),f=d("v-card");return _(),w(f,null,{default:i(()=>[a(v,null,{default:i(()=>[y(p(s(e)("order.moneyAllocation",2)),1)]),_:1}),a(h,null,{default:i(()=>[a(u,{headers:s(r),items:s(o),class:"text-start","hide-default-footer":"",density:"comfortable","items-per-page":-1,hover:""},{"item.method":i(({item:m})=>[a(Se,{method:m.method},null,8,["method"])]),"item.reason":i(({item:m})=>[a(Ce,{reason:m.reason,direction:m.direction},null,8,["reason","direction"])]),_:2},1032,["headers","items"])]),_:1})]),_:1})}}}),Dt=I({__name:"OrderDetails",props:{id:{}},setup(t){const e=t,{model:n}=me(e.id);return(o,r)=>{const c=d("v-col"),l=d("v-spacer"),v=d("v-row"),u=d("v-container");return s(n)?(_(),w(u,{key:0},{default:i(()=>[a(nt,{order:s(n)},null,8,["order"]),a(v,{class:"mt-6",align:"start"},{default:i(()=>[a(c,{cols:"12"},{default:i(()=>[a(it,{order:s(n)},null,8,["order"])]),_:1}),a(c,{cols:"6",md:"4",xl:"2"},{default:i(()=>[a(pt,{order:s(n)},null,8,["order"])]),_:1}),a(l),a(c,{cols:"6",md:"6",xl:"8"},{default:i(()=>[a(Ot,{allocations:[...s(n).allocations]},null,8,["allocations"])]),_:1})]),_:1})]),_:1})):b("",!0)}}});export{Dt as default};
