import{u as se,a as le,_ as ie,d as de,B as ce,e as ue,s as P,f as me}from"./useVariationTableMapper-C-CSkGP-.js";import{g as pe}from"./usePartnerDetails-C1MiMD1f.js";import{d as I,g as $,r as T,c as C,I as z,e as a,l as d,q as i,m as b,x,u as l,$ as B,A as q,F as G,o as _,C as S,a6 as ve,y as h,z as m,H as K,_ as W,a7 as F,a8 as R,a9 as J,aa as M,ab as _e,ac as fe,ad as L,ae as ye,G as N,B as w,a4 as he}from"./index-CTkL5rO_.js";import{g as Q,a as V}from"./useUtils-ws-xled4.js";import{_ as ge}from"./ConfirmDeleteModal.vue_vue_type_script_setup_true_lang-1OX_AV7F.js";import{M as j,u as Oe,_ as we,a as be}from"./MovementReasonChip.vue_vue_type_script_setup_true_lang-Fe2pARa-.js";import{M as xe,a as Me}from"./movementNumberService-CpVm31WL.js";import{g as Ce,n as Se}from"./priceUtils-1yxS_Q4Z.js";function De(t){const e=ke(t);Ie(e,`${t.orderNumber}-printlist.csv`)}function ke(t){return t.items.length?[["MODEL","Size"].join(","),...t.items.flatMap(o=>Be(o))].join(`
\r`):""}function Be(t){const e=`${t.sku.productCode}${t.sku.getSnapshotValues(["size"]).join(" ")}`,n=t.sku.size,o=`${e}, ${n}`;return Array(t.quantity).fill(o)}function Ie(t,e="export.csv"){const n=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.setAttribute("download",e),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o)}const $e=I({__name:"OrderDetailsHeaderMenu",props:{order:{}},setup(t){const e=G(),{tCap:n}=$(),{deleteOrderCommmandHandler:o}=se(),r=t,c=T(!1),s=T(!1);function v(){return`#${r.order.orderNumber}`}function u(){e.back(),o.handle({id:r.order.id})}return(y,f)=>{const p=d("v-btn"),g=d("v-list-item"),O=d("v-list"),D=d("v-menu");return _(),C(z,null,[a(D,{modelValue:c.value,"onUpdate:modelValue":f[2]||(f[2]=A=>c.value=A)},{activator:i(({props:A})=>[a(p,q({icon:"mdi-dots-vertical",variant:"text"},A),null,16)]),default:i(()=>[a(O,null,{default:i(()=>[a(g,{"prepend-icon":"mdi-file-delimited",title:l(n)("order.labelCsvTitle"),onClick:f[0]||(f[0]=A=>l(De)(t.order))},null,8,["title"]),a(g,{"prepend-icon":"mdi-invoice-export-outline",title:l(n)("order.exportInvoiceTitle")},null,8,["title"]),t.order.status===l(B).Draft?(_(),b(g,{key:0,"prepend-icon":"mdi-trash-can",title:l(n)("common.delete"),class:"text-red",onClick:f[1]||(f[1]=()=>{c.value=!1,s.value=!0})},null,8,["title"])):x("",!0)]),_:1})]),_:1},8,["modelValue"]),a(ge,{modelValue:s.value,"onUpdate:modelValue":f[3]||(f[3]=A=>s.value=A),name:v(),"action-fn":()=>u(),hide:""},null,8,["modelValue","name","action-fn"])],64)}}}),U=T();function Ae(){function t(e){U.value?.open(e)}return{dialogRef:U,openApproveModal:t}}const Te={key:0,class:"d-flex button-with-options"},Ve=I({__name:"BtnWithOptions",props:{mainBtnOptions:{},menuOptions:{}},emits:["action"],setup(t,{emit:e}){const n=t,o=S(()=>({"left-btn":n.menuOptions.length>0}));return(r,c)=>{const s=d("v-btn"),v=d("v-icon"),u=d("v-list-item"),y=d("v-list"),f=d("v-menu");return t.mainBtnOptions?(_(),C("div",Te,[a(s,{class:ve(o.value),size:"small",variant:"flat",text:t.mainBtnOptions.title,color:t.mainBtnOptions.color,icon:t.mainBtnOptions.icon,onClick:c[0]||(c[0]=p=>r.$emit("action",t.mainBtnOptions))},{default:i(()=>[h(m(t.mainBtnOptions.title),1)]),_:1},8,["class","text","color","icon"]),t.menuOptions.length>0?(_(),b(f,{key:0,"offset-y":""},{activator:i(({props:p})=>[a(s,q(p,{class:"right-btn",variant:"flat",size:"small",color:t.mainBtnOptions.color}),{default:i(()=>[a(v,null,{default:i(()=>[...c[1]||(c[1]=[h("mdi-chevron-down",-1)])]),_:1})]),_:1},16,["color"])]),default:i(()=>[a(y,null,{default:i(()=>[(_(!0),C(z,null,K(t.menuOptions,p=>(_(),b(u,{"prepend-icon":p.icon,color:p.color,title:p.title,onClick:g=>r.$emit("action",p)},null,8,["prepend-icon","color","title","onClick"]))),256))]),_:1})]),_:1})):x("",!0)])):x("",!0)}}}),Ee=W(Ve,[["__scopeId","data-v-a1906379"]]);class Re{static resolve(e){if(e===j.In)return F.Apply;if(e===j.Out)return F.Reverse;throw new Error("Unsupported money direction")}}class Le{constructor(e=R(),n=J()){this._orderStore=e,this._moneyMovementStore=n}async handle(e){const n=await this.getOrder(e.orderId);if(n.approve(),e.deposit){const o=await this.createMoneyMovement(n.partnerId,n.type,e.deposit.amount,e.deposit.method);this.allocateMoneyToOrder(n,o.direction,o.id,e.deposit.amount),this.saveMoneyMovement(o)}this.updateOrder(n)}async getOrder(e){const n=await M.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async createMoneyMovement(e,n,o,r){const c=await xe.getNext(e);return Me.createPaymentFromOrder(n,e,c,o,r)}allocateMoneyToOrder(e,n,o,r){const c=Re.resolve(n);e.allocateMoney(o,r,c)}async saveMoneyMovement(e){await _e.add(e),this._moneyMovementStore.add(fe.toDTO(e))}async updateOrder(e){await M.update(e),this._orderStore.update(L.toDTO(e))}}class ze{constructor(e=R()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.toProcessing(),await this.updateOrder(n)}async getOrder(e){const n=await M.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await M.update(e),this._orderStore.update(L.toDTO(e))}}class Ne{constructor(e=R()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.readyForShipment(),await this.updateOrder(n)}async getOrder(e){const n=await M.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await M.update(e),this._orderStore.update(L.toDTO(e))}}class He{constructor(e=R()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.shipOrder(),await this.updateOrder(n)}async getOrder(e){const n=await M.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await M.update(e),this._orderStore.update(L.toDTO(e))}}function Pe(t){const e=S(()=>Fe(t.value.status)),{tCap:n}=$();function o(){const u=[r(),c(),s(),v()].filter(p=>p!==null),[y,...f]=u;return{mainBtnOptions:y,menuOptions:f}}function r(){return E(e.value,B.Approved)?{id:"approve",title:n("order.approveBtn"),color:"indigo",execute:async u=>{const y={orderId:t.value.id};u?.amount&&u.amount>0&&u?.method&&(y.deposit={amount:u.amount,method:u.method}),await new Le().handle(y)}}:null}function c(){return E(e.value,B.Processing)?{id:"processing",title:n("order.processingBtn"),color:"indigo",execute:async()=>{try{await new ze().handle({orderId:t.value.id})}catch(u){u instanceof Error&&alert(u.message)}}}:null}function s(){return E(e.value,B.ReadyForShipment)?{id:"readyForShipment",title:n("order.readyForShipmentBtn"),color:"indigo",execute:async()=>{try{await new Ne().handle({orderId:t.value.id})}catch(u){u instanceof Error&&alert(u.message)}}}:null}function v(){return E(e.value,B.Shipped)?{id:"shipped",title:n("order.shippedBtn"),color:"indigo",execute:async()=>{try{await new He().handle({orderId:t.value.id})}catch(u){u instanceof Error&&alert(u.message)}}}:null}return{mainBtnOptions:S(()=>o()),canCancel:S(()=>E(e.value,B.Cancelled)),canComplete:S(()=>E(e.value,B.Completed))}}function Fe(t){return ye[t]}function E(t,e){return t.includes(e)}const je=I({__name:"ApproveOrderModal",setup(t,{expose:e}){const{tCap:n}=$(),{paymentMethodTypes:o}=Oe(),r=T(!1),c=T(!1),s=T(0),v=T(null),u=T(null);let y=null;function f(O){const D=O.initialInput?.amount??0;s.value=Number(D.toFixed(2)),y=O.onConfirm,r.value=!0}function p(){r.value=!1}async function g(){if(y){c.value=!0;try{await y({amount:s.value,method:v.value}),p()}catch(O){O instanceof Error&&(u.value=O.message)}finally{c.value=!1}}}return e({open:f}),(O,D)=>{const A=d("v-card-title"),X=d("v-text-field"),Y=d("v-icon"),Z=d("v-select"),ee=d("v-alert"),te=d("v-card-text"),ne=d("v-spacer"),H=d("v-btn"),oe=d("v-card-actions"),re=d("v-card"),ae=d("v-dialog");return _(),b(ae,{modelValue:r.value,"onUpdate:modelValue":D[2]||(D[2]=k=>r.value=k),"max-width":"420"},{default:i(()=>[a(re,null,{default:i(()=>[a(A,null,{default:i(()=>[h(m(l(n)("order.approveOrderTitle")),1)]),_:1}),a(te,null,{default:i(()=>[a(X,{modelValue:s.value,"onUpdate:modelValue":D[0]||(D[0]=k=>s.value=k),modelModifiers:{number:!0},label:l(n)("order.deposit"),type:"number",min:0,step:"0.01",inputmode:"decimal",suffix:l(Ce)(),autofocus:""},null,8,["modelValue","label","suffix"]),a(Z,{modelValue:v.value,"onUpdate:modelValue":D[1]||(D[1]=k=>v.value=k),label:l(n)("moneyMovement.method"),items:l(o),"item-title":"title","item-value":"value","item-props":k=>({prependIcon:k.icon})},{selection:i(({item:k})=>[a(Y,{class:"mr-2"},{default:i(()=>[h(m(k.raw.icon),1)]),_:2},1024),h(" "+m(k.raw.title),1)]),_:1},8,["modelValue","label","items","item-props"]),u.value?(_(),b(ee,{key:0,type:"error",variant:"tonal",density:"compact",class:"mt-2"},{default:i(()=>[h(m(u.value),1)]),_:1})):x("",!0)]),_:1}),a(oe,null,{default:i(()=>[a(ne),a(H,{variant:"text",onClick:p},{default:i(()=>[h(m(l(n)("common.cancel")),1)]),_:1}),a(H,{color:"indigo",loading:c.value,onClick:g},{default:i(()=>[h(m(l(n)("order.approveBtn")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}});class Ue{constructor(e=R()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.completeOrder(),await this.updateOrder(n)}async getOrder(e){const n=await M.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await M.update(e),this._orderStore.update(L.toDTO(e))}}class qe{constructor(e=R()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.cancelOrder(),await this.updateOrder(n)}async getOrder(e){const n=await M.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await M.update(e),this._orderStore.update(L.toDTO(e))}}const Ge=I({__name:"OrderDetailsHeaderStatus",props:{order:{}},setup(t){const e=t,{tCap:n}=$(),{mainBtnOptions:o,canCancel:r,canComplete:c}=Pe(N(e,"order")),{dialogRef:s,openApproveModal:v}=Ae();function u(p){if(p.id==="approve"){v({initialInput:{amount:e.order.depositAmount},onConfirm:async g=>{p.execute(g)}});return}p.execute()}async function y(){try{await new Ue().handle({orderId:e.order.id})}catch(p){p instanceof Error&&alert(p.message)}}async function f(){try{await new qe().handle({orderId:e.order.id})}catch(p){p instanceof Error&&alert(p.message)}}return(p,g)=>{const O=d("v-btn");return _(),C(z,null,[l(o).mainBtnOptions?(_(),b(Ee,{key:0,"main-btn-options":l(o).mainBtnOptions,"menu-options":l(o).menuOptions,onAction:u,class:"mr-2"},null,8,["main-btn-options","menu-options"])):x("",!0),l(c)?(_(),b(O,{key:1,color:"grey",variant:"flat",size:"small",text:l(n)("order.completedBtn"),class:"mr-2",onClick:y},null,8,["text"])):x("",!0),l(r)?(_(),b(O,{key:2,color:"red",variant:"flat",size:"small",text:l(n)("order.cancelledBtn"),onClick:f},null,8,["text"])):x("",!0),a(je,{ref_key:"dialogRef",ref:s},null,512)],64)}}}),Ke={class:"mr-2"},We={key:0,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},Je={key:1,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},Qe={class:"text-subtitle-1 text-grey-darken-1 font-weight-bold order-details-line"},Xe={class:"formatted-notes"},Ye={class:"text-h5 font-weight-bold"},Ze={key:0},et={key:0},tt=I({__name:"OrderDetailsHeader",props:{order:{}},setup(t){const{tCap:e}=$(),n=t,o=S(()=>pe(n.order.partnerId));function r(){return`#${n.order.orderNumber}`}return(c,s)=>{const v=d("v-col"),u=d("v-row"),y=d("v-btn");return _(),C(z,null,[a(u,{align:"start",justify:"space-between",dense:""},{default:i(()=>[a(v,{cols:"5",class:"d-flex",justify:"start"},{default:i(()=>[w("h1",Ke,m(r()),1),a(le,{status:t.order.status,class:"ml-2 mt-2"},null,8,["status"]),a(ie,{type:t.order.type,class:"ml-2 mt-2"},null,8,["type"])]),_:1}),a(v,{cols:"4",class:"d-flex flex-row justify-end"},{default:i(()=>[a(Ge,{order:t.order},null,8,["order"])]),_:1}),a(v,{cols:"1",class:"d-flex flex-row justify-end"},{default:i(()=>[a($e,{order:t.order},null,8,["order"])]),_:1})]),_:1}),a(u,{align:"start",justify:"space-between",dense:""},{default:i(()=>[a(v,{cols:"3",class:"text-md-left"},{default:i(()=>[o.value?(_(),C("div",We,[w("strong",null,m(l(e)("partner.customer")),1),s[0]||(s[0]=h(": ",-1)),a(y,{variant:"text",to:`/partner/${o.value.id}`},{default:i(()=>[h(m(o.value.businessName),1)]),_:1},8,["to"])])):x("",!0),t.order.dueDate?(_(),C("div",Je,[w("strong",null,m(l(e)("order.dueDate")),1),h(": "+m(l(Q)(t.order.dueDate)),1)])):x("",!0),w("div",Qe,m(l(e)("order.notes"))+": ",1),w("span",Xe,m(t.order.notes),1)]),_:1}),a(v,{cols:"4",md:"5",class:"text-md-right"},{default:i(()=>[w("span",null,m(l(e)("order.total")),1),w("div",Ye,m(l(V)(t.order.totalAmount)),1),w("div",null,[h(m(l(e)("order.orderSum"))+" ",1),w("strong",null,m(l(V)(t.order.subtotal)),1),h(" · "+m(l(e)("order.vatRate"))+" ",1),w("strong",null,m(l(V)(t.order.taxAmount)),1),t.order.discountAmount>0?(_(),C("span",Ze,[h(" · "+m(l(e)("order.discount"))+" ",1),w("strong",null,m(l(V)(t.order.discountAmount)),1)])):x("",!0)]),t.order.depositAmount>0?(_(),C("div",et,[h(m(l(e)("order.deposit"))+" ",1),w("strong",null,m(l(V)(t.order.depositAmount)),1),h(" · "+m(l(e)("order.remainingAmount"))+" ",1),w("strong",null,m(l(V)(t.order.remainingAmount)),1)])):x("",!0)]),_:1})]),_:1})],64)}}}),nt=W(tt,[["__scopeId","data-v-cf0cee66"]]),ot=I({__name:"DisplayTable",props:{tableRows:{},tableColumns:{},hideRowIndex:{type:Boolean}},setup(t){const e=t,n=S(()=>de(e.tableRows));return(o,r)=>(_(),b(ce,{modelValue:n.value,"table-columns":t.tableColumns,"hide-row-index":t.hideRowIndex},null,8,["modelValue","table-columns","hide-row-index"]))}});function rt(t){const e=t.map(at);return st(e)}function at(t){const e=t.sku.variationSnapshot.attributes??{},{size:n,...o}=e;return{name:t.name,unitPrice:t.unitPrice,productCode:t.productCode,derivedSku:he(t.productCode,{attributes:o,flags:t.sku.variationSnapshot.flags}),variationSnapshot:{attributes:o,flags:t.sku.variationSnapshot.flags},sizing:lt(n,t.quantity)}}function st(t){const e=new Map;for(const n of t){const o=n.derivedSku,r=e.get(o);if(r)for(const[c,s]of Object.entries(n.sizing))r.sizing[c]=(r.sizing[c]||0)+s;else e.set(o,{...n,sizing:{...n.sizing}})}return[...e.values()]}function lt(t,e){return{[`shoe:${t}`]:e}}const it=I({__name:"OrderDetailsLineItems",props:{order:{}},setup(t){const{tCap:e}=$(),{vmToRows:n}=ue(P),o=t,r=S(()=>{const c=rt([...o.order.items]);return n(c)});return(c,s)=>{const v=d("v-list-item"),u=d("v-card-title"),y=d("v-card-text"),f=d("v-card");return _(),b(f,null,{default:i(()=>[a(u,null,{default:i(()=>[a(v,null,{title:i(()=>[w("h3",null,m(l(e)("order.items",2)),1)]),_:1})]),_:1}),a(y,null,{default:i(()=>[a(ot,{tableRows:r.value,"table-columns":l(P)},null,8,["tableRows","table-columns"])]),_:1})]),_:1})}}});function dt(t){const{tCap:e}=$(),n=[{name:"created",title:e("order.createdDate"),getDate:r=>r.createdDate},{name:"apporved",title:e("order.approvedDate"),getDate:r=>r.approvedDate},{name:"shipped",title:e("order.shippedDate"),getDate:r=>r.shippedDate},{name:"completed",title:e("order.completedDate"),getDate:r=>r.completedDate}],o={name:"cancelled",title:e("order.cancelledDate"),getDate:r=>r.cancelledDate,isCancelled:!0};return{timelineItems:S(()=>ct(t.value,n,o))}}function ct(t,e,n){const o=[...e];t.status===B.Cancelled&&o.push(n);let r=o.map(s=>({name:s.name,title:s.title,date:s.getDate(t)}));t.status===B.Cancelled&&(r=r.filter(s=>s.date));const c=r.map(s=>s.date).findLastIndex(s=>s!==void 0);return r.map((s,v)=>t.status===B.Cancelled&&s.name==="cancelled"?{...s,colour:"red"}:s.date?{...s,colour:v===c?"indigo":"cyan"}:{...s,colour:"grey"})}const ut={class:"d-flex"},mt={key:0,class:"me-4"},pt=I({__name:"OrderDetailsTimeline",props:{order:{}},setup(t){const{tCap:e}=$(),n=t,{timelineItems:o}=dt(N(n,"order"));return(r,c)=>{const s=d("v-card-title"),v=d("v-divider"),u=d("v-timeline-item"),y=d("v-timeline"),f=d("v-card-text"),p=d("v-card");return _(),b(p,null,{default:i(()=>[a(s,null,{default:i(()=>[h(m(l(e)("common.timeline")),1)]),_:1}),a(v),a(f,null,{default:i(()=>[a(y,{align:"start",side:"end"},{default:i(()=>[(_(!0),C(z,null,K(l(o),g=>(_(),b(u,{"dot-color":g.colour,size:"small"},{opposite:i(()=>[w("div",null,m(g.title),1)]),default:i(()=>[w("div",ut,[g.date?(_(),C("strong",mt,m(l(Q)(g.date)),1)):x("",!0)])]),_:2},1032,["dot-color"]))),256))]),_:1})]),_:1})]),_:1})}}});function vt(t,e){const n=e.find(o=>o.id===t.moneyMovementId);return n?{moneyMovementId:t.moneyMovementId,movementNumber:_t(n?.movementNumber),amount:Se(t.amount),allocatedAt:ft(t.allocatedAt),direction:n.direction,method:n.method,reason:n.reason}:null}function _t(t){return`#${t}`}function ft(t){return t?t.toLocaleDateString():"-"}function yt(t){if(t.length===0)return[];const e=J();return[...new Set(t.map(o=>o.moneyMovementId))].map(o=>e.getMoneyMovementById(o)).filter(o=>o!=null)}function ht(t){return[{title:t("moneyMovement.number"),key:"movementNumber",align:"start"},{title:t("order.allocatedAt"),key:"allocatedAt",align:"start"},{title:t("moneyMovement.reason"),key:"reason",align:"start"},{title:t("moneyMovement.method"),key:"method",align:"start"},{title:t("moneyMovement.amount"),key:"amount",align:"start"}]}function gt(t){const{tCap:e}=$(),n=S(()=>{const r=t.value??[],c=yt(r);return r.map(s=>vt(s,c)).filter(s=>s!=null)}),o=S(()=>ht(e));return{data:n,headers:o}}const Ot=I({__name:"OrderDetailsMoneyAllocations",props:{allocations:{}},setup(t){const e=G(),{tCap:n}=$(),o=t,{data:r,headers:c}=gt(N(o,"allocations"));function s(v,u){e.push(`/moneyMovements/${u.item.moneyMovementId}`)}return(v,u)=>{const y=d("v-card-title"),f=d("v-data-table"),p=d("v-card-text"),g=d("v-card");return _(),b(g,null,{default:i(()=>[a(y,null,{default:i(()=>[h(m(l(n)("order.moneyAllocation",2)),1)]),_:1}),a(p,null,{default:i(()=>[a(f,{headers:l(c),items:l(r),class:"text-start","hide-default-footer":"",density:"comfortable","items-per-page":-1,hover:"","onClick:row":s},{"item.method":i(({item:O})=>[a(be,{method:O.method},null,8,["method"])]),"item.reason":i(({item:O})=>[a(we,{reason:O.reason,direction:O.direction},null,8,["reason","direction"])]),_:2},1032,["headers","items"])]),_:1})]),_:1})}}}),Bt=I({__name:"OrderDetails",props:{id:{}},setup(t){const e=t,{model:n}=me(e.id);return(o,r)=>{const c=d("v-col"),s=d("v-spacer"),v=d("v-row"),u=d("v-container");return l(n)?(_(),b(u,{key:0},{default:i(()=>[a(nt,{order:l(n)},null,8,["order"]),a(v,{class:"mt-6",align:"start"},{default:i(()=>[a(c,{cols:"12"},{default:i(()=>[a(it,{order:l(n)},null,8,["order"])]),_:1}),a(c,{cols:"6",md:"4",xl:"2"},{default:i(()=>[a(pt,{order:l(n)},null,8,["order"])]),_:1}),a(s),a(c,{cols:"6",md:"6",xl:"8"},{default:i(()=>[a(Ot,{allocations:[...l(n).allocations]},null,8,["allocations"])]),_:1})]),_:1})]),_:1})):x("",!0)}}});export{Bt as default};
