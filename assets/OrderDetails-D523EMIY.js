import{u as re,a as ae,_ as se,d as ie,B as le,e as de,s as P,f as ce}from"./useVariationTableMapper-w6eBz1rh.js";import{g as ue}from"./usePartnerDetails-BxyTqyBt.js";import{d as $,g as A,r as T,c as S,I as z,e as r,l as d,q as i,m as x,x as w,u as s,$ as k,A as U,F as me,o as f,C as B,a6 as pe,y,z as m,H as q,_ as G,a7 as H,a8 as R,a9 as ve,aa as b,ab as fe,ac as _e,ad as L,ae as he,G as K,B as g,a4 as ye}from"./index-BxCWqn6m.js";import{n as ge,g as Oe}from"./priceUtils-1yxS_Q4Z.js";import{_ as we}from"./ConfirmDeleteModal.vue_vue_type_script_setup_true_lang-D9jTtcsG.js";import{M as F,a as xe,b as be,u as Ce}from"./useMoneyMovementDetails-CbygyY-0.js";function W(t){return t.toLocaleDateString()}function V(t){return ge(t)}function Se(t){const e=De(t);ke(e,`${t.orderNumber}-printlist.csv`)}function De(t){return t.items.length?[["MODEL","Size"].join(","),...t.items.flatMap(a=>Me(a))].join(`
\r`):""}function Me(t){const e=`${t.sku.productCode}${t.sku.getSnapshotValues(["size"]).join(" ")}`,n=t.sku.size,a=`${e}, ${n}`;return Array(t.quantity).fill(a)}function ke(t,e="export.csv"){const n=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),o=document.createElement("a");o.href=a,o.setAttribute("download",e),document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}const Be=$({__name:"OrderDetailsHeaderMenu",props:{order:{}},setup(t){const e=me(),{tCap:n}=A(),{deleteOrderCommmandHandler:a}=re(),o=t,c=T(!1),l=T(!1);function v(){return`#${o.order.orderNumber}`}function u(){e.back(),a.handle({id:o.order.id})}return(h,_)=>{const p=d("v-btn"),O=d("v-list-item"),C=d("v-list"),D=d("v-menu");return f(),S(z,null,[r(D,{modelValue:c.value,"onUpdate:modelValue":_[2]||(_[2]=I=>c.value=I)},{activator:i(({props:I})=>[r(p,U({icon:"mdi-dots-vertical",variant:"text"},I),null,16)]),default:i(()=>[r(C,null,{default:i(()=>[r(O,{"prepend-icon":"mdi-file-delimited",title:s(n)("order.labelCsvTitle"),onClick:_[0]||(_[0]=I=>s(Se)(t.order))},null,8,["title"]),r(O,{"prepend-icon":"mdi-invoice-export-outline",title:s(n)("order.exportInvoiceTitle")},null,8,["title"]),t.order.status===s(k).Draft?(f(),x(O,{key:0,"prepend-icon":"mdi-trash-can",title:s(n)("common.delete"),class:"text-red",onClick:_[1]||(_[1]=()=>{c.value=!1,l.value=!0})},null,8,["title"])):w("",!0)]),_:1})]),_:1},8,["modelValue"]),r(we,{modelValue:l.value,"onUpdate:modelValue":_[3]||(_[3]=I=>l.value=I),name:v(),"action-fn":()=>u(),hide:""},null,8,["modelValue","name","action-fn"])],64)}}}),j=T();function $e(){function t(e){j.value?.open(e)}return{dialogRef:j,openApproveModal:t}}const Ie={key:0,class:"d-flex button-with-options"},Te=$({__name:"BtnWithOptions",props:{mainBtnOptions:{},menuOptions:{}},emits:["action"],setup(t,{emit:e}){const n=t,a=B(()=>({"left-btn":n.menuOptions.length>0}));return(o,c)=>{const l=d("v-btn"),v=d("v-icon"),u=d("v-list-item"),h=d("v-list"),_=d("v-menu");return t.mainBtnOptions?(f(),S("div",Ie,[r(l,{class:pe(a.value),size:"small",variant:"flat",text:t.mainBtnOptions.title,color:t.mainBtnOptions.color,icon:t.mainBtnOptions.icon,onClick:c[0]||(c[0]=p=>o.$emit("action",t.mainBtnOptions))},{default:i(()=>[y(m(t.mainBtnOptions.title),1)]),_:1},8,["class","text","color","icon"]),t.menuOptions.length>0?(f(),x(_,{key:0,"offset-y":""},{activator:i(({props:p})=>[r(l,U(p,{class:"right-btn",variant:"flat",size:"small",color:t.mainBtnOptions.color}),{default:i(()=>[r(v,null,{default:i(()=>[...c[1]||(c[1]=[y("mdi-chevron-down",-1)])]),_:1})]),_:1},16,["color"])]),default:i(()=>[r(h,null,{default:i(()=>[(f(!0),S(z,null,q(t.menuOptions,p=>(f(),x(u,{"prepend-icon":p.icon,color:p.color,title:p.title,onClick:O=>o.$emit("action",p)},null,8,["prepend-icon","color","title","onClick"]))),256))]),_:1})]),_:1})):w("",!0)])):w("",!0)}}}),Ae=G(Te,[["__scopeId","data-v-a1906379"]]);class Ve{static resolve(e){if(e===F.In)return H.Apply;if(e===F.Out)return H.Reverse;throw new Error("Unsupported money direction")}}class Ee{constructor(e=R(),n=ve()){this._orderStore=e,this._moneyMovementStore=n}async handle(e){const n=await this.getOrder(e.orderId);if(n.approve(),e.deposit){const a=await this.createMoneyMovement(n.partnerId,n.type,e.deposit.amount,e.deposit.method);this.allocateMoneyToOrder(n,a.direction,a.id,e.deposit.amount),this.saveMoneyMovement(a)}this.updateOrder(n)}async getOrder(e){const n=await b.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async createMoneyMovement(e,n,a,o){const c=await xe.getNext(e);return be.createPaymentFromOrder(n,e,c,a,o)}allocateMoneyToOrder(e,n,a,o){const c=Ve.resolve(n);e.allocateMoney(a,o,c)}async saveMoneyMovement(e){await fe.add(e),this._moneyMovementStore.add(_e.toDTO(e))}async updateOrder(e){await b.update(e),this._orderStore.update(L.toDTO(e))}}class Re{constructor(e=R()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.toProcessing(),await this.updateOrder(n)}async getOrder(e){const n=await b.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await b.update(e),this._orderStore.update(L.toDTO(e))}}class Le{constructor(e=R()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.readyForShipment(),await this.updateOrder(n)}async getOrder(e){const n=await b.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await b.update(e),this._orderStore.update(L.toDTO(e))}}class ze{constructor(e=R()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.shipOrder(),await this.updateOrder(n)}async getOrder(e){const n=await b.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await b.update(e),this._orderStore.update(L.toDTO(e))}}function Ne(t){const e=B(()=>Pe(t.value.status)),{tCap:n}=A();function a(){const u=[o(),c(),l(),v()].filter(p=>p!==null),[h,..._]=u;return{mainBtnOptions:h,menuOptions:_}}function o(){return E(e.value,k.Approved)?{id:"approve",title:n("order.approveBtn"),color:"indigo",execute:async u=>{const h={orderId:t.value.id};u?.amount&&u.amount>0&&u?.method&&(h.deposit={amount:u.amount,method:u.method}),await new Ee().handle(h)}}:null}function c(){return E(e.value,k.Processing)?{id:"processing",title:n("order.processingBtn"),color:"indigo",execute:async()=>{try{await new Re().handle({orderId:t.value.id})}catch(u){u instanceof Error&&alert(u.message)}}}:null}function l(){return E(e.value,k.ReadyForShipment)?{id:"readyForShipment",title:n("order.readyForShipmentBtn"),color:"indigo",execute:async()=>{try{await new Le().handle({orderId:t.value.id})}catch(u){u instanceof Error&&alert(u.message)}}}:null}function v(){return E(e.value,k.Shipped)?{id:"shipped",title:n("order.shippedBtn"),color:"indigo",execute:async()=>{try{await new ze().handle({orderId:t.value.id})}catch(u){u instanceof Error&&alert(u.message)}}}:null}return{mainBtnOptions:B(()=>a()),canCancel:B(()=>E(e.value,k.Cancelled)),canComplete:B(()=>E(e.value,k.Completed))}}function Pe(t){return he[t]}function E(t,e){return t.includes(e)}const He=$({__name:"ApproveOrderModal",setup(t,{expose:e}){const{tCap:n}=A(),{paymentMethodTypes:a}=Ce(),o=T(!1),c=T(!1),l=T(0),v=T(null),u=T(null);let h=null;function _(C){const D=C.initialInput?.amount??0;l.value=Number(D.toFixed(2)),h=C.onConfirm,o.value=!0}function p(){o.value=!1}async function O(){if(h){c.value=!0;try{await h({amount:l.value,method:v.value}),p()}catch(C){C instanceof Error&&(u.value=C.message)}finally{c.value=!1}}}return e({open:_}),(C,D)=>{const I=d("v-card-title"),J=d("v-text-field"),Q=d("v-icon"),X=d("v-select"),Y=d("v-alert"),Z=d("v-card-text"),ee=d("v-spacer"),N=d("v-btn"),te=d("v-card-actions"),ne=d("v-card"),oe=d("v-dialog");return f(),x(oe,{modelValue:o.value,"onUpdate:modelValue":D[2]||(D[2]=M=>o.value=M),"max-width":"420"},{default:i(()=>[r(ne,null,{default:i(()=>[r(I,null,{default:i(()=>[y(m(s(n)("order.approveOrderTitle")),1)]),_:1}),r(Z,null,{default:i(()=>[r(J,{modelValue:l.value,"onUpdate:modelValue":D[0]||(D[0]=M=>l.value=M),modelModifiers:{number:!0},label:s(n)("order.deposit"),type:"number",min:0,step:"0.01",inputmode:"decimal",suffix:s(Oe)(),autofocus:""},null,8,["modelValue","label","suffix"]),r(X,{modelValue:v.value,"onUpdate:modelValue":D[1]||(D[1]=M=>v.value=M),label:s(n)("moneyMovement.method"),items:s(a),"item-title":"title","item-value":"value","item-props":M=>({prependIcon:M.icon})},{selection:i(({item:M})=>[r(Q,{class:"mr-2"},{default:i(()=>[y(m(M.raw.icon),1)]),_:2},1024),y(" "+m(M.raw.title),1)]),_:1},8,["modelValue","label","items","item-props"]),u.value?(f(),x(Y,{key:0,type:"error",variant:"tonal",density:"compact",class:"mt-2"},{default:i(()=>[y(m(u.value),1)]),_:1})):w("",!0)]),_:1}),r(te,null,{default:i(()=>[r(ee),r(N,{variant:"text",onClick:p},{default:i(()=>[y(m(s(n)("common.cancel")),1)]),_:1}),r(N,{color:"indigo",loading:c.value,onClick:O},{default:i(()=>[y(m(s(n)("order.approveBtn")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}});class Fe{constructor(e=R()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.completeOrder(),await this.updateOrder(n)}async getOrder(e){const n=await b.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await b.update(e),this._orderStore.update(L.toDTO(e))}}class je{constructor(e=R()){this._orderStore=e}async handle(e){const n=await this.getOrder(e.orderId);n.cancelOrder(),await this.updateOrder(n)}async getOrder(e){const n=await b.getById(e);if(!n)throw new Error(`Order with id ${e} not found`);return n}async updateOrder(e){await b.update(e),this._orderStore.update(L.toDTO(e))}}const Ue=$({__name:"OrderDetailsHeaderStatus",props:{order:{}},setup(t){const e=t,{tCap:n}=A(),{mainBtnOptions:a,canCancel:o,canComplete:c}=Ne(K(e,"order")),{dialogRef:l,openApproveModal:v}=$e();function u(p){if(p.id==="approve"){v({initialInput:{amount:e.order.depositAmount},onConfirm:async O=>{p.execute(O)}});return}p.execute()}async function h(){try{await new Fe().handle({orderId:e.order.id})}catch(p){p instanceof Error&&alert(p.message)}}async function _(){try{await new je().handle({orderId:e.order.id})}catch(p){p instanceof Error&&alert(p.message)}}return(p,O)=>{const C=d("v-btn");return f(),S(z,null,[s(a).mainBtnOptions?(f(),x(Ae,{key:0,"main-btn-options":s(a).mainBtnOptions,"menu-options":s(a).menuOptions,onAction:u,class:"mr-2"},null,8,["main-btn-options","menu-options"])):w("",!0),s(c)?(f(),x(C,{key:1,color:"grey",variant:"flat",size:"small",text:s(n)("order.completedBtn"),class:"mr-2",onClick:h},null,8,["text"])):w("",!0),s(o)?(f(),x(C,{key:2,color:"red",variant:"flat",size:"small",text:s(n)("order.cancelledBtn"),onClick:_},null,8,["text"])):w("",!0),r(He,{ref_key:"dialogRef",ref:l},null,512)],64)}}}),qe={class:"mr-2"},Ge={key:0,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},Ke={key:1,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},We={class:"text-subtitle-1 text-grey-darken-1 font-weight-bold order-details-line"},Je={class:"formatted-notes"},Qe={class:"text-h5 font-weight-bold"},Xe={key:0},Ye={key:0},Ze=$({__name:"OrderDetailsHeader",props:{order:{}},setup(t){const{tCap:e}=A(),n=t,a=B(()=>ue(n.order.partnerId));function o(){return`#${n.order.orderNumber}`}return(c,l)=>{const v=d("v-col"),u=d("v-row"),h=d("v-btn");return f(),S(z,null,[r(u,{align:"start",justify:"space-between",dense:""},{default:i(()=>[r(v,{cols:"5",class:"d-flex",justify:"start"},{default:i(()=>[g("h1",qe,m(o()),1),r(ae,{status:t.order.status,class:"ml-2 mt-2"},null,8,["status"]),r(se,{type:t.order.type,class:"ml-2 mt-2"},null,8,["type"])]),_:1}),r(v,{cols:"4",class:"d-flex flex-row justify-end"},{default:i(()=>[r(Ue,{order:t.order},null,8,["order"])]),_:1}),r(v,{cols:"1",class:"d-flex flex-row justify-end"},{default:i(()=>[r(Be,{order:t.order},null,8,["order"])]),_:1})]),_:1}),r(u,{align:"start",justify:"space-between",dense:""},{default:i(()=>[r(v,{cols:"3",class:"text-md-left"},{default:i(()=>[a.value?(f(),S("div",Ge,[g("strong",null,m(s(e)("partner.customer")),1),l[0]||(l[0]=y(": ",-1)),r(h,{variant:"text",to:`/partner/${a.value.id}`},{default:i(()=>[y(m(a.value.businessName),1)]),_:1},8,["to"])])):w("",!0),t.order.dueDate?(f(),S("div",Ke,[g("strong",null,m(s(e)("order.dueDate")),1),y(": "+m(s(W)(t.order.dueDate)),1)])):w("",!0),g("div",We,m(s(e)("order.notes"))+": ",1),g("span",Je,m(t.order.notes),1)]),_:1}),r(v,{cols:"4",md:"5",class:"text-md-right"},{default:i(()=>[g("span",null,m(s(e)("order.total")),1),g("div",Qe,m(s(V)(t.order.totalAmount)),1),g("div",null,[y(m(s(e)("order.orderSum"))+" ",1),g("strong",null,m(s(V)(t.order.subtotal)),1),y(" · "+m(s(e)("order.vatRate"))+" ",1),g("strong",null,m(s(V)(t.order.taxAmount)),1),t.order.discountAmount>0?(f(),S("span",Xe,[y(" · "+m(s(e)("order.discount"))+" ",1),g("strong",null,m(s(V)(t.order.discountAmount)),1)])):w("",!0)]),t.order.depositAmount>0?(f(),S("div",Ye,[y(m(s(e)("order.deposit"))+" ",1),g("strong",null,m(s(V)(t.order.depositAmount)),1),y(" · "+m(s(e)("order.remainingAmount"))+" ",1),g("strong",null,m(s(V)(t.order.remainingAmount)),1)])):w("",!0)]),_:1})]),_:1})],64)}}}),et=G(Ze,[["__scopeId","data-v-cf0cee66"]]),tt=$({__name:"DisplayTable",props:{tableRows:{},tableColumns:{},hideRowIndex:{type:Boolean}},setup(t){const e=t,n=B(()=>ie(e.tableRows));return(a,o)=>(f(),x(le,{modelValue:n.value,"table-columns":t.tableColumns,"hide-row-index":t.hideRowIndex},null,8,["modelValue","table-columns","hide-row-index"]))}});function nt(t){const e=t.map(ot);return rt(e)}function ot(t){const e=t.sku.variationSnapshot.attributes??{},{size:n,...a}=e;return{name:t.name,unitPrice:t.unitPrice,productCode:t.productCode,derivedSku:ye(t.productCode,{attributes:a,flags:t.sku.variationSnapshot.flags}),variationSnapshot:{attributes:a,flags:t.sku.variationSnapshot.flags},sizing:at(n,t.quantity)}}function rt(t){const e=new Map;for(const n of t){const a=n.derivedSku,o=e.get(a);if(o)for(const[c,l]of Object.entries(n.sizing))o.sizing[c]=(o.sizing[c]||0)+l;else e.set(a,{...n,sizing:{...n.sizing}})}return[...e.values()]}function at(t,e){return{[`shoe:${t}`]:e}}const st=$({__name:"OrderDetailsLineItems",props:{order:{}},setup(t){const{tCap:e}=A(),{vmToRows:n}=de(P),a=t,o=B(()=>{const c=nt([...a.order.items]);return n(c)});return(c,l)=>{const v=d("v-chip"),u=d("v-list-item"),h=d("v-card-title"),_=d("v-card-text"),p=d("v-card");return f(),x(p,null,{default:i(()=>[r(h,null,{default:i(()=>[r(u,null,{title:i(()=>[g("h3",null,m(s(e)("order.items",2)),1)]),append:i(()=>[r(v,{size:"small"},{default:i(()=>[y(m(t.order.items.length),1)]),_:1})]),_:1})]),_:1}),r(_,null,{default:i(()=>[r(tt,{tableRows:o.value,"table-columns":s(P)},null,8,["tableRows","table-columns"])]),_:1})]),_:1})}}});function it(t){const{tCap:e}=A(),n=[{name:"created",title:e("order.createdDate"),getDate:o=>o.createdDate},{name:"apporved",title:e("order.approvedDate"),getDate:o=>o.approvedDate},{name:"shipped",title:e("order.shippedDate"),getDate:o=>o.shippedDate},{name:"completed",title:e("order.completedDate"),getDate:o=>o.completedDate}],a={name:"cancelled",title:e("order.cancelledDate"),getDate:o=>o.cancelledDate,isCancelled:!0};return{timelineItems:B(()=>lt(t.value,n,a))}}function lt(t,e,n){const a=[...e];t.status===k.Cancelled&&a.push(n);let o=a.map(l=>({name:l.name,title:l.title,date:l.getDate(t)}));t.status===k.Cancelled&&(o=o.filter(l=>l.date));const c=o.map(l=>l.date).findLastIndex(l=>l!==void 0);return o.map((l,v)=>t.status===k.Cancelled&&l.name==="cancelled"?{...l,colour:"red"}:l.date?{...l,colour:v===c?"indigo":"cyan"}:{...l,colour:"grey"})}const dt={class:"d-flex"},ct={key:0,class:"me-4"},ut=$({__name:"OrderDetailsTimeline",props:{order:{}},setup(t){const{tCap:e}=A(),n=t,{timelineItems:a}=it(K(n,"order"));return(o,c)=>{const l=d("v-card-title"),v=d("v-divider"),u=d("v-timeline-item"),h=d("v-timeline"),_=d("v-card-text"),p=d("v-card");return f(),x(p,null,{default:i(()=>[r(l,null,{default:i(()=>[y(m(s(e)("common.timeline")),1)]),_:1}),r(v),r(_,null,{default:i(()=>[r(h,{align:"start",side:"end"},{default:i(()=>[(f(!0),S(z,null,q(s(a),O=>(f(),x(u,{"dot-color":O.colour,size:"small"},{opposite:i(()=>[g("div",null,m(O.title),1)]),default:i(()=>[g("div",dt,[O.date?(f(),S("strong",ct,m(s(W)(O.date)),1)):w("",!0)])]),_:2},1032,["dot-color"]))),256))]),_:1})]),_:1})]),_:1})}}}),yt=$({__name:"OrderDetails",props:{id:{}},setup(t){const e=t,{model:n}=ce(e.id);return(a,o)=>{const c=d("v-col"),l=d("v-row"),v=d("v-container");return s(n)?(f(),x(v,{key:0},{default:i(()=>[r(et,{order:s(n)},null,8,["order"]),r(l,{class:"mt-6",align:"start"},{default:i(()=>[r(c,{cols:"12"},{default:i(()=>[r(st,{order:s(n)},null,8,["order"])]),_:1}),r(c,{cols:"6",md:"4",xl:"2"},{default:i(()=>[r(ut,{order:s(n)},null,8,["order"])]),_:1})]),_:1})]),_:1})):w("",!0)}}});export{yt as default};
