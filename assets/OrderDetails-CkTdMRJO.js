import{u as le,b as se,c as ie,d as de,s as G,a as ce,_ as ue,g as me,B as pe,h as ve,m as _e,j as fe}from"./useCSVExport-DmgFlgH-.js";import{g as ye}from"./usePartnerDetails-BhG7zhqX.js";import{d as $,g as V,r as M,c as D,I as P,e as o,l as d,q as s,m as x,x as b,u as r,$ as A,A as X,F as Y,o as _,C as S,a5 as he,y,z as m,H as Z,_ as ee,a6 as J,a7 as F,a8 as te,a9 as C,aa as ge,ab as Oe,ac as H,ad as we,G as W,B as g}from"./index-CeMrVeL6.js";import{g as ne,a as N}from"./useUtils-CXifNUXT.js";import{_ as xe}from"./ConfirmDeleteModal.vue_vue_type_script_setup_true_lang-Do_kMFxc.js";import{M as K,u as be,_ as Ce,a as Me}from"./MovementReasonChip.vue_vue_type_script_setup_true_lang-Crw6NIEh.js";import{M as De,a as Se}from"./movementNumberService-BLSX1btm.js";import{g as Ie,n as Be}from"./priceUtils-Dq5SYNCJ.js";const ke=$({__name:"OrderDetailsHeaderMenu",props:{order:{}},setup(n){const e=Y(),{tCap:t}=V(),{deleteOrderCommmandHandler:a}=le(),l=n,u=M(!1),i=M(!1),p=M(!1),c=M(()=>{}),f=M("");function O(){return`#${l.order.orderNumber}`}function v(){e.back(),a.handle({id:l.order.id})}function w(){c.value=I,f.value=t("order.labelCsvTitle"),p.value=!0}function h(){c.value=z,f.value=t("order.listCsvTitle"),p.value=!0}function I(E){ie(E,l.order.orderNumber)}function z(E){de(E,G,l.order.orderNumber)}return(E,B)=>{const U=d("v-btn"),L=d("v-list-item"),j=d("v-list"),q=d("v-menu");return _(),D(P,null,[o(q,{modelValue:u.value,"onUpdate:modelValue":B[1]||(B[1]=k=>u.value=k)},{activator:s(({props:k})=>[o(U,X({icon:"mdi-dots-vertical",variant:"text"},k),null,16)]),default:s(()=>[o(j,null,{default:s(()=>[o(L,{"prepend-icon":"mdi-file-delimited",title:r(t)("order.listCsvTitle"),onClick:h},null,8,["title"]),o(L,{"prepend-icon":"mdi-label-multiple",title:r(t)("order.labelCsvTitle"),onClick:w},null,8,["title"]),o(L,{"prepend-icon":"mdi-invoice-export-outline",title:r(t)("order.exportInvoiceTitle")},null,8,["title"]),n.order.status===r(A).Draft?(_(),x(L,{key:0,"prepend-icon":"mdi-trash-can",title:r(t)("common.delete"),class:"text-red",onClick:B[0]||(B[0]=()=>{u.value=!1,i.value=!0})},null,8,["title"])):b("",!0)]),_:1})]),_:1},8,["modelValue"]),o(xe,{modelValue:i.value,"onUpdate:modelValue":B[2]||(B[2]=k=>i.value=k),name:O(),"action-fn":()=>v(),hide:""},null,8,["modelValue","name","action-fn"]),o(se,{modelValue:p.value,"onUpdate:modelValue":B[3]||(B[3]=k=>p.value=k),title:f.value,items:[...n.order.items],action:c.value},null,8,["modelValue","title","items","action"])],64)}}}),Q=M();function Te(){function n(e){Q.value?.open(e)}return{dialogRef:Q,openApproveModal:n}}const Ae={key:0,class:"d-flex button-with-options"},$e=$({__name:"BtnWithOptions",props:{mainBtnOptions:{},menuOptions:{}},emits:["action"],setup(n,{emit:e}){const t=n,a=S(()=>({"left-btn":t.menuOptions.length>0}));return(l,u)=>{const i=d("v-btn"),p=d("v-icon"),c=d("v-list-item"),f=d("v-list"),O=d("v-menu");return n.mainBtnOptions?(_(),D("div",Ae,[o(i,{class:he(a.value),size:"small",variant:"flat",text:n.mainBtnOptions.title,color:n.mainBtnOptions.color,icon:n.mainBtnOptions.icon,onClick:u[0]||(u[0]=v=>l.$emit("action",n.mainBtnOptions))},{default:s(()=>[y(m(n.mainBtnOptions.title),1)]),_:1},8,["class","text","color","icon"]),n.menuOptions.length>0?(_(),x(O,{key:0,"offset-y":""},{activator:s(({props:v})=>[o(i,X(v,{class:"right-btn",variant:"flat",size:"small",color:n.mainBtnOptions.color}),{default:s(()=>[o(p,null,{default:s(()=>[...u[1]||(u[1]=[y("mdi-chevron-down",-1)])]),_:1})]),_:1},16,["color"])]),default:s(()=>[o(f,null,{default:s(()=>[(_(!0),D(P,null,Z(n.menuOptions,v=>(_(),x(c,{"prepend-icon":v.icon,color:v.color,title:v.title,onClick:w=>l.$emit("action",v)},null,8,["prepend-icon","color","title","onClick"]))),256))]),_:1})]),_:1})):b("",!0)])):b("",!0)}}}),Ve=ee($e,[["__scopeId","data-v-a1906379"]]);class Ee{static resolve(e){if(e===K.In)return J.Apply;if(e===K.Out)return J.Reverse;throw new Error("Unsupported money direction")}}class Le{constructor(e=F(),t=te()){this._orderStore=e,this._moneyMovementStore=t}async handle(e){const t=await this.getOrder(e.orderId);if(t.approve(),e.deposit){const a=await this.createMoneyMovement(t.partnerId,t.type,e.deposit.amount,e.deposit.method);this.allocateMoneyToOrder(t,a.direction,a.id,e.deposit.amount),this.saveMoneyMovement(a)}this.updateOrder(t)}async getOrder(e){const t=await C.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async createMoneyMovement(e,t,a,l){const u=await De.getNext(e);return Se.createPaymentFromOrder(t,e,u,a,l)}allocateMoneyToOrder(e,t,a,l){const u=Ee.resolve(t);e.allocateMoney(a,l,u)}async saveMoneyMovement(e){await ge.add(e),this._moneyMovementStore.add(Oe.toDTO(e))}async updateOrder(e){await C.update(e),this._orderStore.update(H.toDTO(e))}}class Ne{constructor(e=F()){this._orderStore=e}async handle(e){const t=await this.getOrder(e.orderId);t.toProcessing(),await this.updateOrder(t)}async getOrder(e){const t=await C.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async updateOrder(e){await C.update(e),this._orderStore.update(H.toDTO(e))}}class Re{constructor(e=F()){this._orderStore=e}async handle(e){const t=await this.getOrder(e.orderId);t.readyForShipment(),await this.updateOrder(t)}async getOrder(e){const t=await C.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async updateOrder(e){await C.update(e),this._orderStore.update(H.toDTO(e))}}class Fe{constructor(e=F()){this._orderStore=e}async handle(e){const t=await this.getOrder(e.orderId);t.shipOrder(),await this.updateOrder(t)}async getOrder(e){const t=await C.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async updateOrder(e){await C.update(e),this._orderStore.update(H.toDTO(e))}}function He(n){const e=S(()=>Pe(n.value.status)),{tCap:t}=V();function a(){const c=[l(),u(),i(),p()].filter(v=>v!==null),[f,...O]=c;return{mainBtnOptions:f,menuOptions:O}}function l(){return R(e.value,A.Approved)?{id:"approve",title:t("order.approveBtn"),color:"indigo",execute:async c=>{const f={orderId:n.value.id};c?.amount&&c.amount>0&&c?.method&&(f.deposit={amount:c.amount,method:c.method}),await new Le().handle(f)}}:null}function u(){return R(e.value,A.Processing)?{id:"processing",title:t("order.processingBtn"),color:"indigo",execute:async()=>{try{await new Ne().handle({orderId:n.value.id})}catch(c){c instanceof Error&&alert(c.message)}}}:null}function i(){return R(e.value,A.ReadyForShipment)?{id:"readyForShipment",title:t("order.readyForShipmentBtn"),color:"indigo",execute:async()=>{try{await new Re().handle({orderId:n.value.id})}catch(c){c instanceof Error&&alert(c.message)}}}:null}function p(){return R(e.value,A.Shipped)?{id:"shipped",title:t("order.shippedBtn"),color:"indigo",execute:async()=>{try{await new Fe().handle({orderId:n.value.id})}catch(c){c instanceof Error&&alert(c.message)}}}:null}return{mainBtnOptions:S(()=>a()),canCancel:S(()=>R(e.value,A.Cancelled)),canComplete:S(()=>R(e.value,A.Completed))}}function Pe(n){return we[n]}function R(n,e){return n.includes(e)}const ze=$({__name:"ApproveOrderModal",setup(n,{expose:e}){const{tCap:t}=V(),{paymentMethodTypes:a}=be(),l=M(!1),u=M(!1),i=M(0),p=M(null),c=M(null);let f=null;function O(h){const I=h.initialInput?.amount??0;i.value=Number(I.toFixed(2)),f=h.onConfirm,l.value=!0}function v(){l.value=!1}async function w(){if(f){u.value=!0;try{await f({amount:i.value,method:p.value}),v()}catch(h){h instanceof Error&&(c.value=h.message)}finally{u.value=!1}}}return e({open:O}),(h,I)=>{const z=d("v-card-title"),E=d("v-text-field"),B=d("v-icon"),U=d("v-select"),L=d("v-alert"),j=d("v-card-text"),q=d("v-spacer"),k=d("v-btn"),oe=d("v-card-actions"),re=d("v-card"),ae=d("v-dialog");return _(),x(ae,{modelValue:l.value,"onUpdate:modelValue":I[2]||(I[2]=T=>l.value=T),"max-width":"420"},{default:s(()=>[o(re,null,{default:s(()=>[o(z,null,{default:s(()=>[y(m(r(t)("order.approveOrderTitle")),1)]),_:1}),o(j,null,{default:s(()=>[o(E,{modelValue:i.value,"onUpdate:modelValue":I[0]||(I[0]=T=>i.value=T),modelModifiers:{number:!0},label:r(t)("order.deposit"),type:"number",min:0,step:"0.01",inputmode:"decimal",suffix:r(Ie)(),autofocus:""},null,8,["modelValue","label","suffix"]),o(U,{modelValue:p.value,"onUpdate:modelValue":I[1]||(I[1]=T=>p.value=T),label:r(t)("moneyMovement.method"),items:r(a),"item-title":"title","item-value":"value","item-props":T=>({prependIcon:T.icon})},{selection:s(({item:T})=>[o(B,{class:"mr-2"},{default:s(()=>[y(m(T.raw.icon),1)]),_:2},1024),y(" "+m(T.raw.title),1)]),_:1},8,["modelValue","label","items","item-props"]),c.value?(_(),x(L,{key:0,type:"error",variant:"tonal",density:"compact",class:"mt-2"},{default:s(()=>[y(m(c.value),1)]),_:1})):b("",!0)]),_:1}),o(oe,null,{default:s(()=>[o(q),o(k,{variant:"text",onClick:v},{default:s(()=>[y(m(r(t)("common.cancel")),1)]),_:1}),o(k,{color:"indigo",loading:u.value,onClick:w},{default:s(()=>[y(m(r(t)("order.approveBtn")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}});class Ue{constructor(e=F()){this._orderStore=e}async handle(e){const t=await this.getOrder(e.orderId);t.completeOrder(),await this.updateOrder(t)}async getOrder(e){const t=await C.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async updateOrder(e){await C.update(e),this._orderStore.update(H.toDTO(e))}}class je{constructor(e=F()){this._orderStore=e}async handle(e){const t=await this.getOrder(e.orderId);t.cancelOrder(),await this.updateOrder(t)}async getOrder(e){const t=await C.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async updateOrder(e){await C.update(e),this._orderStore.update(H.toDTO(e))}}const qe=$({__name:"OrderDetailsHeaderStatus",props:{order:{}},setup(n){const e=n,{tCap:t}=V(),{mainBtnOptions:a,canCancel:l,canComplete:u}=He(W(e,"order")),{dialogRef:i,openApproveModal:p}=Te();function c(v){if(v.id==="approve"){p({initialInput:{amount:e.order.depositAmount},onConfirm:async w=>{v.execute(w)}});return}v.execute()}async function f(){try{await new Ue().handle({orderId:e.order.id})}catch(v){v instanceof Error&&alert(v.message)}}async function O(){try{await new je().handle({orderId:e.order.id})}catch(v){v instanceof Error&&alert(v.message)}}return(v,w)=>{const h=d("v-btn");return _(),D(P,null,[r(a).mainBtnOptions?(_(),x(Ve,{key:0,"main-btn-options":r(a).mainBtnOptions,"menu-options":r(a).menuOptions,onAction:c,class:"mr-2"},null,8,["main-btn-options","menu-options"])):b("",!0),r(u)?(_(),x(h,{key:1,color:"grey",variant:"flat",size:"small",text:r(t)("order.completedBtn"),class:"mr-2",onClick:f},null,8,["text"])):b("",!0),r(l)?(_(),x(h,{key:2,color:"red",variant:"flat",size:"small",text:r(t)("order.cancelledBtn"),onClick:O},null,8,["text"])):b("",!0),o(ze,{ref_key:"dialogRef",ref:i},null,512)],64)}}}),Ge={class:"mr-2"},We={key:0,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},Je={key:1,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},Ke={class:"text-subtitle-1 text-grey-darken-1 font-weight-bold order-details-line"},Qe={class:"formatted-notes"},Xe={class:"text-h5 font-weight-bold"},Ye={key:0},Ze={key:0},et=$({__name:"OrderDetailsHeader",props:{order:{}},setup(n){const{tCap:e}=V(),t=n,a=S(()=>ye(t.order.partnerId));function l(){return`#${t.order.orderNumber}`}return(u,i)=>{const p=d("v-col"),c=d("v-row"),f=d("v-btn");return _(),D(P,null,[o(c,{align:"start",justify:"space-between",dense:""},{default:s(()=>[o(p,{cols:"5",class:"d-flex",justify:"start"},{default:s(()=>[g("h1",Ge,m(l()),1),o(ce,{status:n.order.status,class:"ml-2 mt-2"},null,8,["status"]),o(ue,{type:n.order.type,class:"ml-2 mt-2"},null,8,["type"])]),_:1}),o(p,{cols:"4",class:"d-flex flex-row justify-end"},{default:s(()=>[o(qe,{order:n.order},null,8,["order"])]),_:1}),o(p,{cols:"1",class:"d-flex flex-row justify-end"},{default:s(()=>[o(ke,{order:n.order},null,8,["order"])]),_:1})]),_:1}),o(c,{align:"start",justify:"space-between",dense:""},{default:s(()=>[o(p,{cols:"3",class:"text-md-left"},{default:s(()=>[a.value?(_(),D("div",We,[g("strong",null,m(r(e)("partner.customer")),1),i[0]||(i[0]=y(": ",-1)),o(f,{variant:"text",to:`/partner/${a.value.id}`},{default:s(()=>[y(m(a.value.businessName),1)]),_:1},8,["to"])])):b("",!0),n.order.dueDate?(_(),D("div",Je,[g("strong",null,m(r(e)("order.dueDate")),1),y(": "+m(r(ne)(n.order.dueDate)),1)])):b("",!0),g("div",Ke,m(r(e)("order.notes"))+": ",1),g("span",Qe,m(n.order.notes),1)]),_:1}),o(p,{cols:"4",md:"5",class:"text-md-right"},{default:s(()=>[g("span",null,m(r(e)("order.total")),1),g("div",Xe,m(r(N)(n.order.totalAmount)),1),g("div",null,[y(m(r(e)("order.orderSum"))+" ",1),g("strong",null,m(r(N)(n.order.subtotal)),1),y(" · "+m(r(e)("order.vatRate"))+" ",1),g("strong",null,m(r(N)(n.order.taxAmount)),1),n.order.discountAmount>0?(_(),D("span",Ye,[y(" · "+m(r(e)("order.discount"))+" ",1),g("strong",null,m(r(N)(n.order.discountAmount)),1)])):b("",!0)]),n.order.depositAmount>0?(_(),D("div",Ze,[y(m(r(e)("order.deposit"))+" ",1),g("strong",null,m(r(N)(n.order.depositAmount)),1),y(" · "+m(r(e)("order.remainingAmount"))+" ",1),g("strong",null,m(r(N)(n.order.remainingAmount)),1)])):b("",!0)]),_:1})]),_:1})],64)}}}),tt=ee(et,[["__scopeId","data-v-cf0cee66"]]),nt=$({__name:"DisplayTable",props:{tableRows:{},tableColumns:{},hideRowIndex:{type:Boolean}},setup(n){const e=n,t=S(()=>me(e.tableRows));return(a,l)=>(_(),x(pe,{modelValue:t.value,"table-columns":n.tableColumns,"hide-row-index":n.hideRowIndex},null,8,["modelValue","table-columns","hide-row-index"]))}}),ot=$({__name:"OrderDetailsLineItems",props:{order:{}},setup(n){const{tCap:e}=V(),{vmToRows:t}=ve(G),a=n,l=S(()=>{const u=_e([...a.order.items]);return t(u)});return(u,i)=>{const p=d("v-list-item"),c=d("v-card-title"),f=d("v-card-text"),O=d("v-card");return _(),x(O,null,{default:s(()=>[o(c,null,{default:s(()=>[o(p,null,{title:s(()=>[g("h3",null,m(r(e)("order.items",2)),1)]),_:1})]),_:1}),o(f,null,{default:s(()=>[o(nt,{tableRows:l.value,"table-columns":r(G)},null,8,["tableRows","table-columns"])]),_:1})]),_:1})}}});function rt(n){const{tCap:e}=V(),t=[{name:"created",title:e("order.createdDate"),getDate:l=>l.createdDate},{name:"apporved",title:e("order.approvedDate"),getDate:l=>l.approvedDate},{name:"shipped",title:e("order.shippedDate"),getDate:l=>l.shippedDate},{name:"completed",title:e("order.completedDate"),getDate:l=>l.completedDate}],a={name:"cancelled",title:e("order.cancelledDate"),getDate:l=>l.cancelledDate,isCancelled:!0};return{timelineItems:S(()=>at(n.value,t,a))}}function at(n,e,t){const a=[...e];n.status===A.Cancelled&&a.push(t);let l=a.map(i=>({name:i.name,title:i.title,date:i.getDate(n)}));n.status===A.Cancelled&&(l=l.filter(i=>i.date));const u=l.map(i=>i.date).findLastIndex(i=>i!==void 0);return l.map((i,p)=>n.status===A.Cancelled&&i.name==="cancelled"?{...i,colour:"red"}:i.date?{...i,colour:p===u?"indigo":"cyan"}:{...i,colour:"grey"})}const lt={class:"d-flex"},st={key:0,class:"me-4"},it=$({__name:"OrderDetailsTimeline",props:{order:{}},setup(n){const{tCap:e}=V(),t=n,{timelineItems:a}=rt(W(t,"order"));return(l,u)=>{const i=d("v-card-title"),p=d("v-divider"),c=d("v-timeline-item"),f=d("v-timeline"),O=d("v-card-text"),v=d("v-card");return _(),x(v,null,{default:s(()=>[o(i,null,{default:s(()=>[y(m(r(e)("common.timeline")),1)]),_:1}),o(p),o(O,null,{default:s(()=>[o(f,{align:"start",side:"end"},{default:s(()=>[(_(!0),D(P,null,Z(r(a),w=>(_(),x(c,{"dot-color":w.colour,size:"small"},{opposite:s(()=>[g("div",null,m(w.title),1)]),default:s(()=>[g("div",lt,[w.date?(_(),D("strong",st,m(r(ne)(w.date)),1)):b("",!0)])]),_:2},1032,["dot-color"]))),256))]),_:1})]),_:1})]),_:1})}}});function dt(n,e){const t=e.find(a=>a.id===n.moneyMovementId);return t?{moneyMovementId:n.moneyMovementId,movementNumber:ct(t?.movementNumber),amount:Be(n.amount),allocatedAt:ut(n.allocatedAt),direction:t.direction,method:t.method,reason:t.reason}:null}function ct(n){return`#${n}`}function ut(n){return n?n.toLocaleDateString():"-"}function mt(n){if(n.length===0)return[];const e=te();return[...new Set(n.map(a=>a.moneyMovementId))].map(a=>e.getMoneyMovementById(a)).filter(a=>a!=null)}function pt(n){return[{title:n("moneyMovement.number"),key:"movementNumber",align:"start"},{title:n("order.allocatedAt"),key:"allocatedAt",align:"start"},{title:n("moneyMovement.reason"),key:"reason",align:"start"},{title:n("moneyMovement.method"),key:"method",align:"start"},{title:n("moneyMovement.amount"),key:"amount",align:"start"}]}function vt(n){const{tCap:e}=V(),t=S(()=>{const l=n.value??[],u=mt(l);return l.map(i=>dt(i,u)).filter(i=>i!=null)}),a=S(()=>pt(e));return{data:t,headers:a}}const _t=$({__name:"OrderDetailsMoneyAllocations",props:{allocations:{}},setup(n){const e=Y(),{tCap:t}=V(),a=n,{data:l,headers:u}=vt(W(a,"allocations"));function i(p,c){e.push(`/moneyMovements/${c.item.moneyMovementId}`)}return(p,c)=>{const f=d("v-card-title"),O=d("v-data-table"),v=d("v-card-text"),w=d("v-card");return _(),x(w,null,{default:s(()=>[o(f,null,{default:s(()=>[y(m(r(t)("order.moneyAllocation",2)),1)]),_:1}),o(v,null,{default:s(()=>[o(O,{headers:r(u),items:r(l),class:"text-start","hide-default-footer":"",density:"comfortable","items-per-page":-1,hover:"","onClick:row":i},{"item.method":s(({item:h})=>[o(Me,{method:h.method},null,8,["method"])]),"item.reason":s(({item:h})=>[o(Ce,{reason:h.reason,direction:h.direction},null,8,["reason","direction"])]),_:2},1032,["headers","items"])]),_:1})]),_:1})}}}),Ct=$({__name:"OrderDetails",props:{id:{}},setup(n){const e=n,{model:t}=fe(e.id);return(a,l)=>{const u=d("v-col"),i=d("v-spacer"),p=d("v-row"),c=d("v-container");return r(t)?(_(),x(c,{key:0},{default:s(()=>[o(tt,{order:r(t)},null,8,["order"]),o(p,{class:"mt-6",align:"start"},{default:s(()=>[o(u,{cols:"12"},{default:s(()=>[o(ot,{order:r(t)},null,8,["order"])]),_:1}),o(u,{cols:"6",md:"4",xl:"2"},{default:s(()=>[o(it,{order:r(t)},null,8,["order"])]),_:1}),o(i),o(u,{cols:"6",md:"6",xl:"8"},{default:s(()=>[o(_t,{allocations:[...r(t).allocations]},null,8,["allocations"])]),_:1})]),_:1})]),_:1})):b("",!0)}}});export{Ct as default};
