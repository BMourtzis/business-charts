import{g as ue,n as ce}from"./priceUtils-1yxS_Q4Z.js";import{g as x,C as g,ai as D,aj as N,ak as F,a9 as de,al as q,am as U,an as H,Z as pe,d as V,f as ve,j as _e,k as fe,m as b,l as m,u as n,p as B,q as r,e as o,x as ye,y as k,z as C,A as Me,o as w,G as he,F as ge,B as L}from"./index-CJz8f9ss.js";import{u as Ce}from"./usePartners-COd6KVjn.js";import{_ as be}from"./ConfirmDeleteModal.vue_vue_type_script_setup_true_lang-Bze5fObe.js";import{_ as we}from"./PartnerBtn.vue_vue_type_script_setup_true_lang-2MvgKqIS.js";import{g as xe}from"./usePartnerDetails--U1EepqX.js";var h=(e=>(e.Card="Card",e.Bank="Bank",e.Cash="Cash",e.Online="Online",e.Cheque="Cheque",e))(h||{}),y=(e=>(e.In="In",e.Out="Out",e))(y||{}),M=(e=>(e.CustomerPayment="CustomerPayment",e.CustomerRefund="CustomerRefund",e.SupplierPayment="SupplierPayment",e.SupplierRefund="SupplierRefund",e.Adjustment="Adjustment",e))(M||{});function ke(){const{tCap:e}=x();return{paymentMethodTypes:g(()=>Ve(e)),moneyDirectionTypes:g(()=>Ie(e)),movementReasonTypes:g(()=>Se(e))}}function Ve(e){return Object.values(h).map(t=>({title:A(t,e),value:t,icon:E(t)}))}function A(e,t){return t(`moneyMovement.${e.toLowerCase()}`)}function E(e){switch(e){case h.Card:return"mdi-credit-card";case h.Bank:return"mdi-bank";case h.Cash:return"mdi-cash";case h.Online:return"mdi-web";case h.Cheque:return"mdi-checkbook"}}function Ie(e){return Object.values(y).map(t=>({title:Pe(t,e),value:t,icon:Y(t)}))}function Pe(e,t){return t(`moneyMovement.${e.toLowerCase()}`)}function Y(e){switch(e){case y.In:return"mdi-import";case y.Out:return"mdi-export"}}function Re(e){switch(e){case y.In:return"green";case y.Out:return"red"}}function Se(e){return Object.values(M).map(t=>({title:z(t,e),value:t}))}function z(e,t){return t(`moneyMovement.${e.toLowerCase()}`)}class T{static customerPayment(t,a,l,i){return new D(N(),t,a,l,i,y.In,M.CustomerPayment)}static supplierPayment(t,a,l,i){return new D(N(),t,a,l,i,y.Out,M.SupplierPayment)}static customerRefund(t,a,l,i){return new D(N(),t,a,l,i,y.Out,M.CustomerRefund)}}class De{static async getNext(t){const a=new Date().getFullYear()%100,l=await F.load(),i=await de.getById(t);if(!i)throw new Error(`Partner with id:${t} doesn't exist`);const _=l.filter(s=>s.partnerId===t);if(_.length===0)return q.create(a,i.clientNumber,1);const v=_.map(s=>s.sequence).filter(s=>s.year===a).sort((s,c)=>s.format().localeCompare(c.format())).at(-1);if(!v)throw new Error("Error finding the sequence");return q.create(a,i.clientNumber,v.value+1)}}class Ne{constructor(t=U()){this._movementStore=t}async handle(t){const a=await De.getNext(t.partnerId),l=this.createMovement(t,a);await F.add(l),this._movementStore.add(H.toDTO(l))}createMovement(t,a){switch(t.reason){case M.CustomerPayment:return T.customerPayment(a,t.partnerId,t.amount,t.method);case M.SupplierPayment:return T.supplierPayment(a,t.partnerId,t.amount,t.method);case M.CustomerRefund:return T.customerRefund(a,t.partnerId,t.amount,t.method);default:throw new Error("Other reasons are not implemented yet")}}}function G(){const e=U(),{allMovements:t}=pe(e);return{allMoneyMovements:g(()=>t.value.map(H.toModel)),createMoneyMovementCommandHandler:new Ne(e)}}const Te=V({__name:"AddMovementModal",setup(e){const{partners:t,partnersToItemProps:a}=Ce(),{createMoneyMovementCommandHandler:l}=G(),{paymentMethodTypes:i,movementReasonTypes:_}=ke(),{required:v}=ve(),{tCap:s}=x(),c=_e({amount:null,partnerId:null,method:null,reason:null}),{dialog:d,formRef:Z,validForm:I,loading:S,errorMessage:O,close:J,reset:$,submit:K}=fe(c);async function Q(){await K(async f=>{!f.amount||!f.partnerId||!f.method||!f.reason||(await l.handle({partnerId:f.partnerId,amount:Number(f.amount),method:f.method,reason:f.reason}),$())})}return(f,p)=>{const P=m("v-btn"),W=m("v-text-field"),R=m("v-col"),X=m("v-autocomplete"),ee=m("v-icon"),j=m("v-select"),te=m("v-row"),ne=m("v-alert"),oe=m("v-container"),ae=m("v-form"),re=m("v-card-text"),se=m("v-spacer"),me=m("v-card-actions"),le=m("v-card"),ie=m("v-dialog");return w(),b(ie,{modelValue:n(d),"onUpdate:modelValue":p[5]||(p[5]=u=>B(d)?d.value=u:null),"max-width":"800"},{activator:r(({props:u})=>[o(P,Me(u,{color:"indigo",text:n(s)("moneyMovement.addMoneyMovement"),"prepend-icon":"mdi-plus",variant:"flat"}),null,16,["text"])]),default:r(()=>[o(le,{title:n(s)("moneyMovement.addMoneyMovement")},{default:r(()=>[o(re,null,{default:r(()=>[o(ae,{ref_key:"formRef",ref:Z,modelValue:n(I),"onUpdate:modelValue":p[4]||(p[4]=u=>B(I)?I.value=u:null)},{default:r(()=>[o(oe,{fluid:""},{default:r(()=>[o(te,{dense:""},{default:r(()=>[o(R,{cols:"6"},{default:r(()=>[o(W,{modelValue:c.amount,"onUpdate:modelValue":p[0]||(p[0]=u=>c.amount=u),type:"number",label:n(s)("moneyMovement.amount"),rules:[n(v)],min:0,step:"0.01",inputmode:"decimal",suffix:n(ue)()},null,8,["modelValue","label","rules","suffix"])]),_:1}),o(R,{cols:"6"},{default:r(()=>[o(X,{modelValue:c.partnerId,"onUpdate:modelValue":p[1]||(p[1]=u=>c.partnerId=u),"item-props":n(a),label:n(s)("partner.partner"),items:n(t),rules:[n(v)]},null,8,["modelValue","item-props","label","items","rules"])]),_:1}),o(R,{cols:"6"},{default:r(()=>[o(j,{modelValue:c.method,"onUpdate:modelValue":p[2]||(p[2]=u=>c.method=u),label:n(s)("moneyMovement.method"),items:n(i),rules:[n(v)],"item-title":"title","item-value":"value","item-props":u=>({prependIcon:u.icon})},{selection:r(({item:u})=>[o(ee,{class:"mr-2"},{default:r(()=>[k(C(u.raw.icon),1)]),_:2},1024),k(" "+C(u.raw.title),1)]),_:1},8,["modelValue","label","items","rules","item-props"])]),_:1}),o(R,{cols:"6"},{default:r(()=>[o(j,{modelValue:c.reason,"onUpdate:modelValue":p[3]||(p[3]=u=>c.reason=u),label:n(s)("moneyMovement.reason"),items:n(_),rules:[n(v)],"item-title":"title","item-value":"value"},null,8,["modelValue","label","items","rules"])]),_:1})]),_:1}),n(O)?(w(),b(ne,{key:0,type:"error",variant:"tonal",density:"compact",class:"mt-2"},{default:r(()=>[k(C(n(O)),1)]),_:1})):ye("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1}),o(me,null,{default:r(()=>[o(P,{variant:"tonal",color:"warning",text:n(s)("common.clear"),onClick:n($)},null,8,["text","onClick"]),o(se),o(P,{variant:"tonal",color:"indigo",text:n(s)("common.save"),loading:n(S),disabled:!n(I)||n(S),onClick:Q},null,8,["text","loading","disabled"]),o(P,{text:n(s)("common.cancel"),color:"red",disabled:n(S),onClick:n(J)},null,8,["text","disabled","onClick"])]),_:1})]),_:1},8,["title"])]),_:1},8,["modelValue"])}}}),Oe=V({__name:"PaymentMethodChip",props:{method:{}},setup(e){const{tCap:t}=x();return(a,l)=>{const i=m("v-chip");return w(),b(i,{variant:"outlined",color:"indigo","prepend-icon":n(E)(e.method)},{default:r(()=>[k(C(n(A)(e.method,n(t))),1)]),_:1},8,["prepend-icon"])}}}),$e=V({__name:"MovementReasonChip",props:{reason:{},direction:{}},setup(e){const{tCap:t}=x();return(a,l)=>{const i=m("v-chip");return w(),b(i,{variant:"outlined",color:n(Re)(e.direction),"prepend-icon":n(Y)(e.direction)},{default:r(()=>[k(C(n(z)(e.reason,n(t))),1)]),_:1},8,["color","prepend-icon"])}}});function je(e){return{id:e.id,movementNumber:qe(e.movementNumber),partner:xe(e.partnerId),createdDate:Be(e.createdDate),amount:ce(e.amount),method:e.method,direction:e.direction,reason:e.reason}}function qe(e){return`#${e}`}function Be(e){return e?e.toLocaleDateString():"-"}function Le(e){return[{title:e("moneyMovement.number"),key:"movementNumber",align:"start"},{title:e("partner.businessName"),key:"partner",align:"start"},{title:e("moneyMovement.createdDate"),key:"createdDate",align:"start"},{title:e("moneyMovement.reason"),key:"reason",align:"start"},{title:e("moneyMovement.method"),key:"method",align:"start"},{title:e("moneyMovement.amount"),key:"amount",align:"start"}]}function Fe(e){const{tCap:t}=x(),a=g(()=>(e.value??[]).map(_=>je(_))),l=g(()=>Le(t));return{data:a,headers:l}}const Ue=V({__name:"MoneyMovementList",props:{moneyMovements:{}},setup(e){const t=ge(),a=e,{data:l,headers:i}=Fe(he(a,"moneyMovements"));function _(v,s){t.push(`/moneyMovements/${s.item.id}`)}return(v,s)=>{const c=m("v-data-table");return w(),b(c,{headers:n(i),items:n(l),class:"text-start","hide-default-footer":"",density:"comfortable","items-per-page":-1,hover:"","onClick:row":_},{"item.partner":r(({item:d})=>[o(we,{partner:d.partner},null,8,["partner"])]),"item.method":r(({item:d})=>[o(Oe,{method:d.method},null,8,["method"])]),"item.reason":r(({item:d})=>[o($e,{reason:d.reason,direction:d.direction},null,8,["reason","direction"])]),"item.actions":r(({item:d})=>[o(be,{name:d.movementNumber,"action-fn":()=>"",mini:!0},null,8,["name"])]),_:2},1032,["headers","items"])}}}),He={class:"d-flex justify-space-between align-center mb-4"},Ae={class:"text-h6"},Ke=V({__name:"MoneyMovementView",setup(e){const{tCap:t}=x(),{allMoneyMovements:a}=G();return(l,i)=>{const _=m("v-card"),v=m("v-container");return w(),b(v,{class:"py-6"},{default:r(()=>[o(_,{class:"pa-4"},{default:r(()=>[L("div",He,[L("h2",Ae,C(n(t)("moneyMovement.moneyMovement",2)),1),o(Te)]),o(Ue,{"money-movements":n(a)},null,8,["money-movements"])]),_:1})]),_:1})}}});export{Ke as default};
