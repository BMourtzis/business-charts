import{u as le,b as se,a as ie,_ as de,e as ce,B as ue,f as me,m as pe,s as G,h as ve}from"./useOrders-BSLASp72.js";import{g as _e}from"./usePartnerDetails-CpwqrI22.js";import{d as A,g as $,r as C,c as D,I as H,e as o,l as d,q as l,m as x,x as b,u as r,$ as k,A as Q,F as X,o as _,C as I,a5 as fe,y,z as m,H as Y,_ as Z,a6 as W,a7 as L,a8 as ee,a9 as M,aa as ye,ab as he,ac as F,ad as ge,G as j,B as g}from"./index-BTMAe9ol.js";import{g as te,a as N}from"./useUtils-CXifNUXT.js";import{_ as Oe}from"./ConfirmDeleteModal.vue_vue_type_script_setup_true_lang-CsjEiVBC.js";import{M as J,u as we,_ as xe,a as be}from"./MovementReasonChip.vue_vue_type_script_setup_true_lang-Cf3gld0z.js";import{M as Me,a as Ce}from"./movementNumberService-Cjz9DKXK.js";import{g as De,n as Ie}from"./priceUtils-Dq5SYNCJ.js";const Se=A({__name:"OrderDetailsHeaderMenu",props:{order:{}},setup(n){const e=X(),{tCap:t}=$(),{deleteOrderCommmandHandler:a}=le(),s=n,u=C(!1),i=C(!1),p=C(!1),c=C("lineItems"),f=C(s.order.orderNumber);function O(){return`#${s.order.orderNumber}`}function v(){e.back(),a.handle({id:s.order.id})}function w(){c.value="labels",p.value=!0}function h(){c.value="lineItems",p.value=!0}return(T,S)=>{const P=d("v-btn"),E=d("v-list-item"),z=d("v-list"),U=d("v-menu");return _(),D(H,null,[o(U,{modelValue:u.value,"onUpdate:modelValue":S[1]||(S[1]=V=>u.value=V)},{activator:l(({props:V})=>[o(P,Q({icon:"mdi-dots-vertical",variant:"text"},V),null,16)]),default:l(()=>[o(z,null,{default:l(()=>[o(E,{"prepend-icon":"mdi-file-delimited",title:r(t)("order.listCsvTitle"),onClick:h},null,8,["title"]),o(E,{"prepend-icon":"mdi-label-multiple",title:r(t)("order.labelCsvTitle"),onClick:w},null,8,["title"]),o(E,{"prepend-icon":"mdi-invoice-export-outline",title:r(t)("order.exportInvoiceTitle")},null,8,["title"]),n.order.status===r(k).Draft?(_(),x(E,{key:0,"prepend-icon":"mdi-trash-can",title:r(t)("common.delete"),class:"text-red",onClick:S[0]||(S[0]=()=>{u.value=!1,i.value=!0})},null,8,["title"])):b("",!0)]),_:1})]),_:1},8,["modelValue"]),o(Oe,{modelValue:i.value,"onUpdate:modelValue":S[2]||(S[2]=V=>i.value=V),name:O(),"action-fn":()=>v(),hide:""},null,8,["modelValue","name","action-fn"]),o(se,{modelValue:p.value,"onUpdate:modelValue":S[3]||(S[3]=V=>p.value=V),filename:f.value,items:[...n.order.items],type:c.value},null,8,["modelValue","filename","items","type"])],64)}}}),K=C();function Be(){function n(e){K.value?.open(e)}return{dialogRef:K,openApproveModal:n}}const ke={key:0,class:"d-flex button-with-options"},Ae=A({__name:"BtnWithOptions",props:{mainBtnOptions:{},menuOptions:{}},emits:["action"],setup(n,{emit:e}){const t=n,a=I(()=>({"left-btn":t.menuOptions.length>0}));return(s,u)=>{const i=d("v-btn"),p=d("v-icon"),c=d("v-list-item"),f=d("v-list"),O=d("v-menu");return n.mainBtnOptions?(_(),D("div",ke,[o(i,{class:fe(a.value),size:"small",variant:"flat",text:n.mainBtnOptions.title,color:n.mainBtnOptions.color,icon:n.mainBtnOptions.icon,onClick:u[0]||(u[0]=v=>s.$emit("action",n.mainBtnOptions))},{default:l(()=>[y(m(n.mainBtnOptions.title),1)]),_:1},8,["class","text","color","icon"]),n.menuOptions.length>0?(_(),x(O,{key:0,"offset-y":""},{activator:l(({props:v})=>[o(i,Q(v,{class:"right-btn",variant:"flat",size:"small",color:n.mainBtnOptions.color}),{default:l(()=>[o(p,null,{default:l(()=>[...u[1]||(u[1]=[y("mdi-chevron-down",-1)])]),_:1})]),_:1},16,["color"])]),default:l(()=>[o(f,null,{default:l(()=>[(_(!0),D(H,null,Y(n.menuOptions,v=>(_(),x(c,{"prepend-icon":v.icon,color:v.color,title:v.title,onClick:w=>s.$emit("action",v)},null,8,["prepend-icon","color","title","onClick"]))),256))]),_:1})]),_:1})):b("",!0)])):b("",!0)}}}),$e=Z(Ae,[["__scopeId","data-v-a1906379"]]);class Te{static resolve(e){if(e===J.In)return W.Apply;if(e===J.Out)return W.Reverse;throw new Error("Unsupported money direction")}}class Ve{constructor(e=L(),t=ee()){this._orderStore=e,this._moneyMovementStore=t}async handle(e){const t=await this.getOrder(e.orderId);if(t.approve(),e.deposit){const a=await this.createMoneyMovement(t.partnerId,t.type,e.deposit.amount,e.deposit.method);this.allocateMoneyToOrder(t,a.direction,a.id,e.deposit.amount),this.saveMoneyMovement(a)}this.updateOrder(t)}async getOrder(e){const t=await M.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async createMoneyMovement(e,t,a,s){const u=await Me.getNext(e);return Ce.createPaymentFromOrder(t,e,u,a,s)}allocateMoneyToOrder(e,t,a,s){const u=Te.resolve(t);e.allocateMoney(a,s,u)}async saveMoneyMovement(e){await ye.add(e),this._moneyMovementStore.add(he.toDTO(e))}async updateOrder(e){await M.update(e),this._orderStore.update(F.toDTO(e))}}class Ee{constructor(e=L()){this._orderStore=e}async handle(e){const t=await this.getOrder(e.orderId);t.toProcessing(),await this.updateOrder(t)}async getOrder(e){const t=await M.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async updateOrder(e){await M.update(e),this._orderStore.update(F.toDTO(e))}}class Ne{constructor(e=L()){this._orderStore=e}async handle(e){const t=await this.getOrder(e.orderId);t.readyForShipment(),await this.updateOrder(t)}async getOrder(e){const t=await M.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async updateOrder(e){await M.update(e),this._orderStore.update(F.toDTO(e))}}class Re{constructor(e=L()){this._orderStore=e}async handle(e){const t=await this.getOrder(e.orderId);t.shipOrder(),await this.updateOrder(t)}async getOrder(e){const t=await M.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async updateOrder(e){await M.update(e),this._orderStore.update(F.toDTO(e))}}function Le(n){const e=I(()=>Fe(n.value.status)),{tCap:t}=$();function a(){const c=[s(),u(),i(),p()].filter(v=>v!==null),[f,...O]=c;return{mainBtnOptions:f,menuOptions:O}}function s(){return R(e.value,k.Approved)?{id:"approve",title:t("order.approveBtn"),color:"indigo",execute:async c=>{const f={orderId:n.value.id};c?.amount&&c.amount>0&&c?.method&&(f.deposit={amount:c.amount,method:c.method}),await new Ve().handle(f)}}:null}function u(){return R(e.value,k.Processing)?{id:"processing",title:t("order.processingBtn"),color:"indigo",execute:async()=>{try{await new Ee().handle({orderId:n.value.id})}catch(c){c instanceof Error&&alert(c.message)}}}:null}function i(){return R(e.value,k.ReadyForShipment)?{id:"readyForShipment",title:t("order.readyForShipmentBtn"),color:"indigo",execute:async()=>{try{await new Ne().handle({orderId:n.value.id})}catch(c){c instanceof Error&&alert(c.message)}}}:null}function p(){return R(e.value,k.Shipped)?{id:"shipped",title:t("order.shippedBtn"),color:"indigo",execute:async()=>{try{await new Re().handle({orderId:n.value.id})}catch(c){c instanceof Error&&alert(c.message)}}}:null}return{mainBtnOptions:I(()=>a()),canCancel:I(()=>R(e.value,k.Cancelled)),canComplete:I(()=>R(e.value,k.Completed))}}function Fe(n){return ge[n]}function R(n,e){return n.includes(e)}const He=A({__name:"ApproveOrderModal",setup(n,{expose:e}){const{tCap:t}=$(),{paymentMethodTypes:a}=we(),s=C(!1),u=C(!1),i=C(0),p=C(null),c=C(null);let f=null;function O(h){const T=h.initialInput?.amount??0;i.value=Number(T.toFixed(2)),f=h.onConfirm,s.value=!0}function v(){s.value=!1}async function w(){if(f){u.value=!0;try{await f({amount:i.value,method:p.value}),v()}catch(h){h instanceof Error&&(c.value=h.message)}finally{u.value=!1}}}return e({open:O}),(h,T)=>{const S=d("v-card-title"),P=d("v-text-field"),E=d("v-icon"),z=d("v-select"),U=d("v-alert"),V=d("v-card-text"),ne=d("v-spacer"),q=d("v-btn"),oe=d("v-card-actions"),re=d("v-card"),ae=d("v-dialog");return _(),x(ae,{modelValue:s.value,"onUpdate:modelValue":T[2]||(T[2]=B=>s.value=B),"max-width":"420"},{default:l(()=>[o(re,null,{default:l(()=>[o(S,null,{default:l(()=>[y(m(r(t)("order.approveOrderTitle")),1)]),_:1}),o(V,null,{default:l(()=>[o(P,{modelValue:i.value,"onUpdate:modelValue":T[0]||(T[0]=B=>i.value=B),modelModifiers:{number:!0},label:r(t)("order.deposit"),type:"number",min:0,step:"0.01",inputmode:"decimal",suffix:r(De)(),autofocus:""},null,8,["modelValue","label","suffix"]),o(z,{modelValue:p.value,"onUpdate:modelValue":T[1]||(T[1]=B=>p.value=B),label:r(t)("moneyMovement.method"),items:r(a),"item-title":"title","item-value":"value","item-props":B=>({prependIcon:B.icon})},{selection:l(({item:B})=>[o(E,{class:"mr-2"},{default:l(()=>[y(m(B.raw.icon),1)]),_:2},1024),y(" "+m(B.raw.title),1)]),_:1},8,["modelValue","label","items","item-props"]),c.value?(_(),x(U,{key:0,type:"error",variant:"tonal",density:"compact",class:"mt-2"},{default:l(()=>[y(m(c.value),1)]),_:1})):b("",!0)]),_:1}),o(oe,null,{default:l(()=>[o(ne),o(q,{variant:"text",onClick:v},{default:l(()=>[y(m(r(t)("common.cancel")),1)]),_:1}),o(q,{color:"indigo",loading:u.value,onClick:w},{default:l(()=>[y(m(r(t)("order.approveBtn")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}});class Pe{constructor(e=L()){this._orderStore=e}async handle(e){const t=await this.getOrder(e.orderId);t.completeOrder(),await this.updateOrder(t)}async getOrder(e){const t=await M.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async updateOrder(e){await M.update(e),this._orderStore.update(F.toDTO(e))}}class ze{constructor(e=L()){this._orderStore=e}async handle(e){const t=await this.getOrder(e.orderId);t.cancelOrder(),await this.updateOrder(t)}async getOrder(e){const t=await M.getById(e);if(!t)throw new Error(`Order with id ${e} not found`);return t}async updateOrder(e){await M.update(e),this._orderStore.update(F.toDTO(e))}}const Ue=A({__name:"OrderDetailsHeaderStatus",props:{order:{}},setup(n){const e=n,{tCap:t}=$(),{mainBtnOptions:a,canCancel:s,canComplete:u}=Le(j(e,"order")),{dialogRef:i,openApproveModal:p}=Be();function c(v){if(v.id==="approve"){p({initialInput:{amount:e.order.depositAmount},onConfirm:async w=>{v.execute(w)}});return}v.execute()}async function f(){try{await new Pe().handle({orderId:e.order.id})}catch(v){v instanceof Error&&alert(v.message)}}async function O(){try{await new ze().handle({orderId:e.order.id})}catch(v){v instanceof Error&&alert(v.message)}}return(v,w)=>{const h=d("v-btn");return _(),D(H,null,[r(a).mainBtnOptions?(_(),x($e,{key:0,"main-btn-options":r(a).mainBtnOptions,"menu-options":r(a).menuOptions,onAction:c,class:"mr-2"},null,8,["main-btn-options","menu-options"])):b("",!0),r(u)?(_(),x(h,{key:1,color:"grey",variant:"flat",size:"small",text:r(t)("order.completedBtn"),class:"mr-2",onClick:f},null,8,["text"])):b("",!0),r(s)?(_(),x(h,{key:2,color:"red",variant:"flat",size:"small",text:r(t)("order.cancelledBtn"),onClick:O},null,8,["text"])):b("",!0),o(He,{ref_key:"dialogRef",ref:i},null,512)],64)}}}),je={class:"mr-2"},qe={key:0,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},Ge={key:1,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},We={class:"text-subtitle-1 text-grey-darken-1 font-weight-bold order-details-line"},Je={class:"formatted-notes"},Ke={class:"text-h5 font-weight-bold"},Qe={key:0},Xe={key:0},Ye=A({__name:"OrderDetailsHeader",props:{order:{}},setup(n){const{tCap:e}=$(),t=n,a=I(()=>_e(t.order.partnerId));function s(){return`#${t.order.orderNumber}`}return(u,i)=>{const p=d("v-col"),c=d("v-row"),f=d("v-btn");return _(),D(H,null,[o(c,{align:"start",justify:"space-between",dense:""},{default:l(()=>[o(p,{cols:"5",class:"d-flex",justify:"start"},{default:l(()=>[g("h1",je,m(s()),1),o(ie,{status:n.order.status,class:"ml-2 mt-2"},null,8,["status"]),o(de,{type:n.order.type,class:"ml-2 mt-2"},null,8,["type"])]),_:1}),o(p,{cols:"4",class:"d-flex flex-row justify-end"},{default:l(()=>[o(Ue,{order:n.order},null,8,["order"])]),_:1}),o(p,{cols:"1",class:"d-flex flex-row justify-end"},{default:l(()=>[o(Se,{order:n.order},null,8,["order"])]),_:1})]),_:1}),o(c,{align:"start",justify:"space-between",dense:""},{default:l(()=>[o(p,{cols:"3",class:"text-md-left"},{default:l(()=>[a.value?(_(),D("div",qe,[g("strong",null,m(r(e)("partner.customer")),1),i[0]||(i[0]=y(": ",-1)),o(f,{variant:"text",to:`/partner/${a.value.id}`},{default:l(()=>[y(m(a.value.businessName),1)]),_:1},8,["to"])])):b("",!0),n.order.dueDate?(_(),D("div",Ge,[g("strong",null,m(r(e)("order.dueDate")),1),y(": "+m(r(te)(n.order.dueDate)),1)])):b("",!0),g("div",We,m(r(e)("order.notes"))+": ",1),g("span",Je,m(n.order.notes),1)]),_:1}),o(p,{cols:"4",md:"5",class:"text-md-right"},{default:l(()=>[g("span",null,m(r(e)("order.total")),1),g("div",Ke,m(r(N)(n.order.totalAmount)),1),g("div",null,[y(m(r(e)("order.orderSum"))+" ",1),g("strong",null,m(r(N)(n.order.subtotal)),1),y(" · "+m(r(e)("order.vatRate"))+" ",1),g("strong",null,m(r(N)(n.order.taxAmount)),1),n.order.discountAmount>0?(_(),D("span",Qe,[y(" · "+m(r(e)("order.discount"))+" ",1),g("strong",null,m(r(N)(n.order.discountAmount)),1)])):b("",!0)]),n.order.depositAmount>0?(_(),D("div",Xe,[y(m(r(e)("order.deposit"))+" ",1),g("strong",null,m(r(N)(n.order.depositAmount)),1),y(" · "+m(r(e)("order.remainingAmount"))+" ",1),g("strong",null,m(r(N)(n.order.remainingAmount)),1)])):b("",!0)]),_:1})]),_:1})],64)}}}),Ze=Z(Ye,[["__scopeId","data-v-cf0cee66"]]),et=A({__name:"DisplayTable",props:{tableRows:{},tableColumns:{},hideRowIndex:{type:Boolean}},setup(n){const e=n,t=I(()=>ce(e.tableRows));return(a,s)=>(_(),x(ue,{modelValue:t.value,"table-columns":n.tableColumns,"hide-row-index":n.hideRowIndex},null,8,["modelValue","table-columns","hide-row-index"]))}}),tt=A({__name:"OrderDetailsLineItems",props:{order:{}},setup(n){const{tCap:e}=$(),{vmToRows:t}=me(G),a=n,s=I(()=>{const u=pe([...a.order.items]);return t(u)});return(u,i)=>{const p=d("v-list-item"),c=d("v-card-title"),f=d("v-card-text"),O=d("v-card");return _(),x(O,null,{default:l(()=>[o(c,null,{default:l(()=>[o(p,null,{title:l(()=>[g("h3",null,m(r(e)("order.items",2)),1)]),_:1})]),_:1}),o(f,null,{default:l(()=>[o(et,{tableRows:s.value,"table-columns":r(G)},null,8,["tableRows","table-columns"])]),_:1})]),_:1})}}});function nt(n){const{tCap:e}=$(),t=[{name:"created",title:e("order.createdDate"),getDate:s=>s.createdDate},{name:"apporved",title:e("order.approvedDate"),getDate:s=>s.approvedDate},{name:"shipped",title:e("order.shippedDate"),getDate:s=>s.shippedDate},{name:"completed",title:e("order.completedDate"),getDate:s=>s.completedDate}],a={name:"cancelled",title:e("order.cancelledDate"),getDate:s=>s.cancelledDate,isCancelled:!0};return{timelineItems:I(()=>ot(n.value,t,a))}}function ot(n,e,t){const a=[...e];n.status===k.Cancelled&&a.push(t);let s=a.map(i=>({name:i.name,title:i.title,date:i.getDate(n)}));n.status===k.Cancelled&&(s=s.filter(i=>i.date));const u=s.map(i=>i.date).findLastIndex(i=>i!==void 0);return s.map((i,p)=>n.status===k.Cancelled&&i.name==="cancelled"?{...i,colour:"red"}:i.date?{...i,colour:p===u?"indigo":"cyan"}:{...i,colour:"grey"})}const rt={class:"d-flex"},at={key:0,class:"me-4"},lt=A({__name:"OrderDetailsTimeline",props:{order:{}},setup(n){const{tCap:e}=$(),t=n,{timelineItems:a}=nt(j(t,"order"));return(s,u)=>{const i=d("v-card-title"),p=d("v-divider"),c=d("v-timeline-item"),f=d("v-timeline"),O=d("v-card-text"),v=d("v-card");return _(),x(v,null,{default:l(()=>[o(i,null,{default:l(()=>[y(m(r(e)("common.timeline")),1)]),_:1}),o(p),o(O,null,{default:l(()=>[o(f,{align:"start",side:"end"},{default:l(()=>[(_(!0),D(H,null,Y(r(a),w=>(_(),x(c,{"dot-color":w.colour,size:"small"},{opposite:l(()=>[g("div",null,m(w.title),1)]),default:l(()=>[g("div",rt,[w.date?(_(),D("strong",at,m(r(te)(w.date)),1)):b("",!0)])]),_:2},1032,["dot-color"]))),256))]),_:1})]),_:1})]),_:1})}}});function st(n,e){const t=e.find(a=>a.id===n.moneyMovementId);return t?{moneyMovementId:n.moneyMovementId,movementNumber:it(t?.movementNumber),amount:Ie(n.amount),allocatedAt:dt(n.allocatedAt),direction:t.direction,method:t.method,reason:t.reason}:null}function it(n){return`#${n}`}function dt(n){return n?n.toLocaleDateString():"-"}function ct(n){if(n.length===0)return[];const e=ee();return[...new Set(n.map(a=>a.moneyMovementId))].map(a=>e.getMoneyMovementById(a)).filter(a=>a!=null)}function ut(n){return[{title:n("moneyMovement.number"),key:"movementNumber",align:"start"},{title:n("order.allocatedAt"),key:"allocatedAt",align:"start"},{title:n("moneyMovement.reason"),key:"reason",align:"start"},{title:n("moneyMovement.method"),key:"method",align:"start"},{title:n("moneyMovement.amount"),key:"amount",align:"start"}]}function mt(n){const{tCap:e}=$(),t=I(()=>{const s=n.value??[],u=ct(s);return s.map(i=>st(i,u)).filter(i=>i!=null)}),a=I(()=>ut(e));return{data:t,headers:a}}const pt=A({__name:"OrderDetailsMoneyAllocations",props:{allocations:{}},setup(n){const e=X(),{tCap:t}=$(),a=n,{data:s,headers:u}=mt(j(a,"allocations"));function i(p,c){e.push(`/moneyMovements/${c.item.moneyMovementId}`)}return(p,c)=>{const f=d("v-card-title"),O=d("v-data-table"),v=d("v-card-text"),w=d("v-card");return _(),x(w,null,{default:l(()=>[o(f,null,{default:l(()=>[y(m(r(t)("order.moneyAllocation",2)),1)]),_:1}),o(v,null,{default:l(()=>[o(O,{headers:r(u),items:r(s),class:"text-start","hide-default-footer":"",density:"comfortable","items-per-page":-1,hover:"","onClick:row":i},{"item.method":l(({item:h})=>[o(be,{method:h.method},null,8,["method"])]),"item.reason":l(({item:h})=>[o(xe,{reason:h.reason,direction:h.direction},null,8,["reason","direction"])]),_:2},1032,["headers","items"])]),_:1})]),_:1})}}}),xt=A({__name:"OrderDetails",props:{id:{}},setup(n){const e=n,{model:t}=ve(e.id);return(a,s)=>{const u=d("v-col"),i=d("v-spacer"),p=d("v-row"),c=d("v-container");return r(t)?(_(),x(c,{key:0},{default:l(()=>[o(Ze,{order:r(t)},null,8,["order"]),o(p,{class:"mt-6",align:"start"},{default:l(()=>[o(u,{cols:"12"},{default:l(()=>[o(tt,{order:r(t)},null,8,["order"])]),_:1}),o(u,{cols:"6",md:"4",xl:"2"},{default:l(()=>[o(lt,{order:r(t)},null,8,["order"])]),_:1}),o(i),o(u,{cols:"6",md:"6",xl:"8"},{default:l(()=>[o(pt,{allocations:[...r(t).allocations]},null,8,["allocations"])]),_:1})]),_:1})]),_:1})):b("",!0)}}});export{xt as default};
