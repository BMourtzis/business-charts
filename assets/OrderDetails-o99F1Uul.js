import{u as ne,a as oe,_ as re,d as ae,B as se,e as le,s as R,f as ie}from"./useVariationTableMapper-SbVFo9xc.js";import{g as ce}from"./usePartnerDetails-BKQIxFdI.js";import{d as S,g as V,r as $,c as C,I,e as o,l as c,q as l,m as b,x,u as s,a5 as M,A as U,F as de,o as v,C as k,a6 as ue,y,z as u,H as F,_ as H,a7 as N,a8 as me,a9 as pe,aa as E,ab as ve,ac as _e,ad as fe,ae as ge,G as q,B as h,a3 as ye}from"./index-BegK-sUb.js";import{n as he,g as xe}from"./priceUtils-1yxS_Q4Z.js";import{_ as be}from"./ConfirmDeleteModal.vue_vue_type_script_setup_true_lang-q5XVqtH_.js";import{M as P,a as Oe,b as Ce,u as we}from"./useMoneyMovementDetails-D0NeUU-l.js";function G(e){return e.toLocaleDateString()}function T(e){return he(e)}function De(e){const t=Me(e);Se(t,`${e.orderNumber}-printlist.csv`)}function Me(e){return e.items.length?[["MODEL","Size"].join(","),...e.items.flatMap(a=>ke(a))].join(`
\r`):""}function ke(e){const t=`${e.sku.productCode}${e.sku.getSnapshotValues(["size"]).join(" ")}`,n=e.sku.size,a=`${t}, ${n}`;return Array(e.quantity).fill(a)}function Se(e,t="export.csv"){const n=new Blob([e],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.setAttribute("download",t),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}const Be=S({__name:"OrderDetailsHeaderMenu",props:{order:{}},setup(e){const t=de(),{tCap:n}=V(),{deleteOrderCommmandHandler:a}=ne(),r=e,d=$(!1),i=$(!1);function m(){return`#${r.order.orderNumber}`}function p(){t.back(),a.handle({id:r.order.id})}return(_,f)=>{const g=c("v-btn"),O=c("v-list-item"),B=c("v-list"),w=c("v-menu");return v(),C(I,null,[o(w,{modelValue:d.value,"onUpdate:modelValue":f[2]||(f[2]=A=>d.value=A)},{activator:l(({props:A})=>[o(g,U({icon:"mdi-dots-vertical",variant:"text"},A),null,16)]),default:l(()=>[o(B,null,{default:l(()=>[o(O,{"prepend-icon":"mdi-file-delimited",title:s(n)("order.labelCsvTitle"),onClick:f[0]||(f[0]=A=>s(De)(e.order))},null,8,["title"]),o(O,{"prepend-icon":"mdi-invoice-export-outline",title:s(n)("order.exportInvoiceTitle")},null,8,["title"]),e.order.status===s(M).Draft?(v(),b(O,{key:0,"prepend-icon":"mdi-trash-can",title:s(n)("common.delete"),class:"text-red",onClick:f[1]||(f[1]=()=>{d.value=!1,i.value=!0})},null,8,["title"])):x("",!0)]),_:1})]),_:1},8,["modelValue"]),o(be,{modelValue:i.value,"onUpdate:modelValue":f[3]||(f[3]=A=>i.value=A),name:m(),"action-fn":()=>p(),hide:""},null,8,["modelValue","name","action-fn"])],64)}}}),j=$();function Ae(){function e(t){j.value?.open(t)}return{dialogRef:j,openApproveModal:e}}const $e={key:0,class:"d-flex button-with-options"},Ve=S({__name:"BtnWithOptions",props:{mainBtnOptions:{},menuOptions:{}},emits:["action"],setup(e,{emit:t}){const n=e,a=k(()=>({"left-btn":n.menuOptions.length>0}));return(r,d)=>{const i=c("v-btn"),m=c("v-icon"),p=c("v-list-item"),_=c("v-list"),f=c("v-menu");return e.mainBtnOptions?(v(),C("div",$e,[o(i,{class:ue(a.value),size:"small",variant:"flat",text:e.mainBtnOptions.title,color:e.mainBtnOptions.color,icon:e.mainBtnOptions.icon,onClick:d[0]||(d[0]=g=>r.$emit("action",e.mainBtnOptions))},{default:l(()=>[y(u(e.mainBtnOptions.title),1)]),_:1},8,["class","text","color","icon"]),e.menuOptions.length>0?(v(),b(f,{key:0,"offset-y":""},{activator:l(({props:g})=>[o(i,U(g,{class:"right-btn",variant:"flat",size:"small",color:e.mainBtnOptions.color}),{default:l(()=>[o(m,null,{default:l(()=>[...d[1]||(d[1]=[y("mdi-chevron-down",-1)])]),_:1})]),_:1},16,["color"])]),default:l(()=>[o(_,null,{default:l(()=>[(v(!0),C(I,null,F(e.menuOptions,g=>(v(),b(p,{"prepend-icon":g.icon,color:g.color,title:g.title,onClick:O=>r.$emit("action",g)},null,8,["prepend-icon","color","title","onClick"]))),256))]),_:1})]),_:1})):x("",!0)])):x("",!0)}}}),Te=H(Ve,[["__scopeId","data-v-a1906379"]]);class ze{static resolve(t){if(t===P.In)return N.Apply;if(t===P.Out)return N.Reverse;throw new Error("Unsupported money direction")}}class Ie{constructor(t=me(),n=pe()){this._orderStore=t,this._moneyMovementStore=n}async handle(t){const n=await this.getOrder(t.orderId);if(n.approve(),t.deposit){const a=await this.createMoneyMovement(n.partnerId,n.type,t.deposit.amount,t.deposit.method);this.allocateMoneyToOrder(n,a.direction,a.id,t.deposit.amount),this.saveMoneyMovement(a)}this.updateOrder(n)}async getOrder(t){const n=await E.getById(t);if(!n)throw new Error(`Order with id ${t} not found`);return n}async createMoneyMovement(t,n,a,r){const d=await Oe.getNext(t);return Ce.createPaymentFromOrder(n,t,d,a,r)}allocateMoneyToOrder(t,n,a,r){const d=ze.resolve(n);t.allocateMoney(a,r,d)}async saveMoneyMovement(t){await ve.add(t),this._moneyMovementStore.add(_e.toDTO(t))}async updateOrder(t){await E.update(t),this._orderStore.update(fe.toDTO(t))}}function Le(e){const t=k(()=>Re(e.value.status)),{tCap:n}=V();function a(){const p=[r(),d(),i(),m()].filter(g=>g!==null),[_,...f]=p;return{mainBtnOptions:_,menuOptions:f}}function r(){return z(t.value,M.Approved)?{id:"approve",title:n("order.approveBtn"),color:"indigo",execute:async p=>{const _={orderId:e.value.id};p?.amount&&p.amount>0&&p?.method&&(_.deposit={amount:p.amount,method:p.method}),await new Ie().handle(_)}}:null}function d(){return z(t.value,M.Processing)?{id:"processing",title:n("order.processingBtn"),color:"indigo",execute:async()=>{}}:null}function i(){return z(t.value,M.ReadyForShipment)?{id:"readyForShipment",title:n("order.readyForShipmentBtn"),color:"indigo",execute:async()=>{}}:null}function m(){return z(t.value,M.Shipped)?{id:"shipped",title:n("order.shippedBtn"),color:"indigo",execute:async()=>{}}:null}return{mainBtnOptions:k(()=>a()),canCancel:k(()=>z(t.value,M.Cancelled)),canComplete:k(()=>z(t.value,M.Completed))}}function Re(e){return ge[e]}function z(e,t){return e.includes(t)}const Ne=S({__name:"ApproveOrderModal",setup(e,{expose:t}){const{tCap:n}=V(),{paymentMethodTypes:a}=we(),r=$(!1),d=$(!1),i=$(0),m=$(null),p=$(null);let _=null;function f(B){const w=B.initialInput?.amount??0;i.value=Number(w.toFixed(2)),_=B.onConfirm,r.value=!0}function g(){r.value=!1}async function O(){if(_){d.value=!0;try{await _({amount:i.value,method:m.value}),g()}catch(B){B instanceof Error&&(p.value=B.message)}finally{d.value=!1}}}return t({open:f}),(B,w)=>{const A=c("v-card-title"),K=c("v-text-field"),W=c("v-icon"),J=c("v-select"),Q=c("v-alert"),X=c("v-card-text"),Y=c("v-spacer"),L=c("v-btn"),Z=c("v-card-actions"),ee=c("v-card"),te=c("v-dialog");return v(),b(te,{modelValue:r.value,"onUpdate:modelValue":w[2]||(w[2]=D=>r.value=D),"max-width":"420"},{default:l(()=>[o(ee,null,{default:l(()=>[o(A,null,{default:l(()=>[y(u(s(n)("order.approveOrderTitle")),1)]),_:1}),o(X,null,{default:l(()=>[o(K,{modelValue:i.value,"onUpdate:modelValue":w[0]||(w[0]=D=>i.value=D),modelModifiers:{number:!0},label:s(n)("order.deposit"),type:"number",min:0,step:"0.01",inputmode:"decimal",suffix:s(xe)(),autofocus:""},null,8,["modelValue","label","suffix"]),o(J,{modelValue:m.value,"onUpdate:modelValue":w[1]||(w[1]=D=>m.value=D),label:s(n)("moneyMovement.method"),items:s(a),"item-title":"title","item-value":"value","item-props":D=>({prependIcon:D.icon})},{selection:l(({item:D})=>[o(W,{class:"mr-2"},{default:l(()=>[y(u(D.raw.icon),1)]),_:2},1024),y(" "+u(D.raw.title),1)]),_:1},8,["modelValue","label","items","item-props"]),p.value?(v(),b(Q,{key:0,type:"error",variant:"tonal",density:"compact",class:"mt-2"},{default:l(()=>[y(u(p.value),1)]),_:1})):x("",!0)]),_:1}),o(Z,null,{default:l(()=>[o(Y),o(L,{variant:"text",onClick:g},{default:l(()=>[y(u(s(n)("common.cancel")),1)]),_:1}),o(L,{color:"indigo",loading:d.value,onClick:O},{default:l(()=>[y(u(s(n)("order.approveBtn")),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])}}}),Ee=S({__name:"OrderDetailsHeaderStatus",props:{order:{}},setup(e){const t=e,{tCap:n}=V(),{mainBtnOptions:a,canCancel:r,canComplete:d}=Le(q(t,"order")),{dialogRef:i,openApproveModal:m}=Ae();function p(_){if(_.id==="approve"){m({initialInput:{amount:t.order.depositAmount},onConfirm:async f=>{_.execute(f)}});return}_.execute()}return(_,f)=>{const g=c("v-btn");return v(),C(I,null,[o(Te,{"main-btn-options":s(a).mainBtnOptions,"menu-options":s(a).menuOptions,onAction:p,class:"mr-2"},null,8,["main-btn-options","menu-options"]),s(d)?(v(),b(g,{key:0,color:"grey",variant:"flat",size:"small",text:s(n)("order.completedBtn"),class:"mr-2"},null,8,["text"])):x("",!0),s(r)?(v(),b(g,{key:1,color:"red",variant:"flat",size:"small",text:s(n)("order.cancelledBtn")},null,8,["text"])):x("",!0),o(Ne,{ref_key:"dialogRef",ref:i},null,512)],64)}}}),Pe={class:"mr-2"},je={key:0,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},Ue={key:1,class:"text-subtitle-1 text-grey-darken-1 order-details-line"},Fe={class:"text-subtitle-1 text-grey-darken-1 font-weight-bold order-details-line"},He={class:"formatted-notes"},qe={class:"text-h5 font-weight-bold"},Ge={key:0},Ke={key:0},We=S({__name:"OrderDetailsHeader",props:{order:{}},setup(e){const{tCap:t}=V(),n=e,a=k(()=>ce(n.order.partnerId));function r(){return`#${n.order.orderNumber}`}return(d,i)=>{const m=c("v-col"),p=c("v-row"),_=c("v-btn");return v(),C(I,null,[o(p,{align:"start",justify:"space-between",dense:""},{default:l(()=>[o(m,{cols:"5",class:"d-flex",justify:"start"},{default:l(()=>[h("h1",Pe,u(r()),1),o(oe,{status:e.order.status,class:"ml-2 mt-2"},null,8,["status"]),o(re,{type:e.order.type,class:"ml-2 mt-2"},null,8,["type"])]),_:1}),o(m,{cols:"4",class:"d-flex flex-row justify-end"},{default:l(()=>[o(Ee,{order:e.order},null,8,["order"])]),_:1}),o(m,{cols:"1",class:"d-flex flex-row justify-end"},{default:l(()=>[o(Be,{order:e.order},null,8,["order"])]),_:1})]),_:1}),o(p,{align:"start",justify:"space-between",dense:""},{default:l(()=>[o(m,{cols:"3",class:"text-md-left"},{default:l(()=>[a.value?(v(),C("div",je,[h("strong",null,u(s(t)("partner.customer")),1),i[0]||(i[0]=y(": ",-1)),o(_,{variant:"text",to:`/partner/${a.value.id}`},{default:l(()=>[y(u(a.value.businessName),1)]),_:1},8,["to"])])):x("",!0),e.order.dueDate?(v(),C("div",Ue,[h("strong",null,u(s(t)("order.dueDate")),1),y(": "+u(s(G)(e.order.dueDate)),1)])):x("",!0),h("div",Fe,u(s(t)("order.notes"))+": ",1),h("span",He,u(e.order.notes),1)]),_:1}),o(m,{cols:"4",md:"5",class:"text-md-right"},{default:l(()=>[h("span",null,u(s(t)("order.total")),1),h("div",qe,u(s(T)(e.order.totalAmount)),1),h("div",null,[y(u(s(t)("order.orderSum"))+" ",1),h("strong",null,u(s(T)(e.order.subtotal)),1),y(" · "+u(s(t)("order.vatRate"))+" ",1),h("strong",null,u(s(T)(e.order.taxAmount)),1),e.order.discountAmount>0?(v(),C("span",Ge,[y(" · "+u(s(t)("order.discount"))+" ",1),h("strong",null,u(s(T)(e.order.discountAmount)),1)])):x("",!0)]),e.order.depositAmount>0?(v(),C("div",Ke,[y(u(s(t)("order.deposit"))+" ",1),h("strong",null,u(s(T)(e.order.depositAmount)),1),y(" · "+u(s(t)("order.remainingAmount"))+" ",1),h("strong",null,u(s(T)(e.order.remainingAmount)),1)])):x("",!0)]),_:1})]),_:1})],64)}}}),Je=H(We,[["__scopeId","data-v-cf0cee66"]]),Qe=S({__name:"DisplayTable",props:{tableRows:{},tableColumns:{},hideRowIndex:{type:Boolean}},setup(e){const t=e,n=k(()=>ae(t.tableRows));return(a,r)=>(v(),b(se,{modelValue:n.value,"table-columns":e.tableColumns,"hide-row-index":e.hideRowIndex},null,8,["modelValue","table-columns","hide-row-index"]))}});function Xe(e){const t=e.map(Ye);return Ze(t)}function Ye(e){const t=e.sku.variationSnapshot.attributes??{},{size:n,...a}=t;return{name:e.name,unitPrice:e.unitPrice,productCode:e.productCode,derivedSku:ye(e.productCode,{attributes:a,flags:e.sku.variationSnapshot.flags}),variationSnapshot:{attributes:a,flags:e.sku.variationSnapshot.flags},sizing:et(n,e.quantity)}}function Ze(e){const t=new Map;for(const n of e){const a=n.derivedSku,r=t.get(a);if(r)for(const[d,i]of Object.entries(n.sizing))r.sizing[d]=(r.sizing[d]||0)+i;else t.set(a,{...n,sizing:{...n.sizing}})}return[...t.values()]}function et(e,t){return{[`shoe:${e}`]:t}}const tt=S({__name:"OrderDetailsLineItems",props:{order:{}},setup(e){const{tCap:t}=V(),{vmToRows:n}=le(R),a=e,r=k(()=>{const d=Xe([...a.order.items]);return n(d)});return(d,i)=>{const m=c("v-chip"),p=c("v-list-item"),_=c("v-card-title"),f=c("v-card-text"),g=c("v-card");return v(),b(g,null,{default:l(()=>[o(_,null,{default:l(()=>[o(p,null,{title:l(()=>[h("h3",null,u(s(t)("order.items",2)),1)]),append:l(()=>[o(m,{size:"small"},{default:l(()=>[y(u(e.order.items.length),1)]),_:1})]),_:1})]),_:1}),o(f,null,{default:l(()=>[o(Qe,{tableRows:r.value,"table-columns":s(R)},null,8,["tableRows","table-columns"])]),_:1})]),_:1})}}});function nt(e){const{tCap:t}=V(),n=[{name:t("order.createdDate"),getDate:r=>r.createdDate},{name:t("order.approvedDate"),getDate:r=>r.approvedDate},{name:t("order.shippedDate"),getDate:r=>r.shippedDate},{name:t("order.completedDate"),getDate:r=>r.completedDate}],a={name:t("order.cancelledDate"),getDate:r=>r.cancelledDate,isCancelled:!0};return{timelineItems:k(()=>ot(e.value,n,a))}}function ot(e,t,n){const a=[...t];e.status===M.Cancelled&&a.push(n);const r=a.map(i=>({name:i.name,date:i.getDate(e)})),d=r.map(i=>i.date).findLastIndex(i=>i!==void 0);return r.map((i,m)=>e.status===M.Cancelled&&i.name==="Cancelled"?{...i,colour:"red"}:i.date?{...i,colour:m===d?"indigo":"cyan"}:{...i,colour:"grey"})}const rt={class:"d-flex"},at={key:0,class:"me-4"},st=S({__name:"OrderDetailsTimeline",props:{order:{}},setup(e){const{tCap:t}=V(),n=e,{timelineItems:a}=nt(q(n,"order"));return(r,d)=>{const i=c("v-card-title"),m=c("v-divider"),p=c("v-timeline-item"),_=c("v-timeline"),f=c("v-card-text"),g=c("v-card");return v(),b(g,null,{default:l(()=>[o(i,null,{default:l(()=>[y(u(s(t)("common.timeline")),1)]),_:1}),o(m),o(f,null,{default:l(()=>[o(_,{align:"start",side:"end",direction:"horizontal"},{default:l(()=>[(v(!0),C(I,null,F(s(a),O=>(v(),b(p,{"dot-color":O.colour,size:"small"},{opposite:l(()=>[h("div",null,u(O.name),1)]),default:l(()=>[h("div",rt,[O.date?(v(),C("strong",at,u(s(G)(O.date)),1)):x("",!0)])]),_:2},1032,["dot-color"]))),256))]),_:1})]),_:1})]),_:1})}}}),pt=S({__name:"OrderDetails",props:{id:{}},setup(e){const t=e,{model:n}=ie(t.id);return(a,r)=>{const d=c("v-col"),i=c("v-row"),m=c("v-container");return s(n)?(v(),b(m,{key:0},{default:l(()=>[o(Je,{order:s(n)},null,8,["order"]),o(i,{class:"mt-6",align:"start"},{default:l(()=>[o(d,{cols:"12"},{default:l(()=>[o(tt,{order:s(n)},null,8,["order"])]),_:1}),o(d,{cols:"12",md:"12",xl:"12"},{default:l(()=>[o(st,{order:s(n)},null,8,["order"])]),_:1})]),_:1})]),_:1})):x("",!0)}}});export{pt as default};
